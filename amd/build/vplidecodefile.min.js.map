{"version":3,"sources":["../src/vplidecodefile.js"],"names":["define","$","VPLUtil","self","editor","session","readOnly","getFileManager","getOldContent","getContent","isOpen","call","getValue","setOldContent","setContent","c","setValue","oldDestroy","destroy","setFontSize","size","oldAdjustSize","adjustSize","resize","gotoLine","line","scrollToLine","focus","setReadOnly","s","tid","getTId","removeClass","addClass","blur","undo","redo","selectAll","hasUndo","getUndoManager","hasRedo","hasSelectAll","returnTrue","hasFind","hasFindReplace","hasNext","find","execCommand","replace","next","getAnnotations","setAnnotations","a","clearAnnotations","langSelection","ext","fileExtension","getFileName","lang","langType","setMode","getEditor","setTheme","theme","open","showFileName","ace","loadScript","fileManager","require","edit","getId","getSession","setOptions","enableBasicAutocompletion","enableSnippets","getFontSize","getTheme","setUseSoftTabs","setTabSize","setUndoManager","UndoManager","setOpen","addEventDrop","tag","length","on","dropHandler","button","trigger","setTimeout","change","prevOnPaste","onPaste","restrictedEdit","insert","getClipboard","t","setClipboard","restrictedPaste","dragoverHandler","close"],"mappings":"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","sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Code files extension method using ACE editorfiles. Add to VPLFile object.\n *\n * @package mod_vpl\n * @copyright 2013 Juan Carlos Rodríguez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\n/* globals ace */\n\ndefine(\n    [\n        'jquery',\n        'mod_vpl/vplutil',\n    ],\n    function($, VPLUtil) {\n        return function() {\n            var self = this;\n            var editor = null;\n            var session = null;\n            var readOnly = self.getFileManager().readOnly;\n            var getOldContent = this.getContent;\n            this.getContent = function() {\n                if (!this.isOpen()) {\n                    return getOldContent.call(this);\n                }\n                return editor.getValue();\n            };\n            var setOldContent = this.setContent;\n            this.setContent = function(c) {\n                setOldContent.call(this, c);\n                if (this.isOpen()) {\n                    editor.setValue(c);\n                }\n            };\n            var oldDestroy = this.destroy;\n            this.destroy = function() {\n                if (this.isOpen()) {\n                    editor.destroy();\n                }\n                oldDestroy.call(this);\n            };\n            this.setFontSize = function(size) {\n                if (this.isOpen()) {\n                    editor.setFontSize(size);\n                }\n            };\n            var oldAdjustSize = this.adjustSize;\n            this.adjustSize = function() {\n                if (oldAdjustSize.call(this)) {\n                    editor.resize();\n                    return true;\n                }\n                return false;\n            };\n            this.gotoLine = function(line) {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.gotoLine(line, 0);\n                editor.scrollToLine(line, true);\n                editor.focus();\n            };\n            this.setReadOnly = function(s) {\n                readOnly = s;\n                if (this.isOpen()) {\n                    editor.setReadOnly(s);\n                }\n            };\n            this.focus = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                var tid = this.getTId();\n                $(tid).removeClass('ui-widget-content ui-tabs-panel');\n                $(tid).addClass('ui-corner-bottom');\n                this.adjustSize();\n                editor.focus();\n            };\n            this.blur = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.blur();\n            };\n            this.undo = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.undo();\n                editor.focus();\n            };\n            this.redo = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.redo();\n                editor.focus();\n            };\n            this.selectAll = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.selectAll();\n                editor.focus();\n            };\n            this.hasUndo = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.getUndoManager().hasUndo();\n            };\n            this.hasRedo = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.getUndoManager().hasRedo();\n            };\n            this.hasSelectAll = VPLUtil.returnTrue;\n            this.hasFind = VPLUtil.returnTrue;\n            this.hasFindReplace = VPLUtil.returnTrue;\n            this.hasNext = VPLUtil.returnTrue;\n            this.find = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.execCommand('find');\n            };\n            this.replace = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.execCommand('replace');\n            };\n            this.next = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.execCommand('findnext');\n            };\n            this.getAnnotations = function() {\n                if (!this.isOpen()) {\n                    return [];\n                }\n                return session.getAnnotations();\n            };\n            this.setAnnotations = function(a) {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.setAnnotations(a);\n            };\n            this.clearAnnotations = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.clearAnnotations();\n            };\n            this.langSelection = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                var ext = VPLUtil.fileExtension(this.getFileName());\n                var lang = 'text';\n                if (ext !== '') {\n                    lang = VPLUtil.langType(ext);\n                }\n                session.setMode(\"ace/mode/\" + lang);\n            };\n            this.getEditor = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return editor;\n            };\n            this.setTheme = function(theme) {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.setTheme(\"ace/theme/\" + theme);\n            };\n            this.open = function() {\n                this.showFileName();\n                if (typeof ace === 'undefined') {\n                    VPLUtil.loadScript(['../editor/ace9/ace.js',\n                        '../editor/ace9/ext-language_tools.js'],\n                        function() {\n                            self.open();\n                        });\n                    return false;\n                }\n                if (this.isOpen()) {\n                    return false;\n                }\n                var fileManager = this.getFileManager();\n                var tid = this.getTId();\n                // Workaround to remove jquery-ui theme background color.\n                $(tid).removeClass('ui-widget-content ui-tabs-panel');\n                $(tid).addClass('ui-corner-bottom');\n                ace.require(\"ext/language_tools\");\n                editor = ace.edit(\"vpl_file\" + this.getId());\n                session = editor.getSession();\n                editor.setOptions({\n                    enableBasicAutocompletion: true,\n                    enableSnippets: true,\n                });\n                editor.setValue(this.getContent());\n                editor.setFontSize(fileManager.getFontSize());\n                editor.setTheme(\"ace/theme/\" + fileManager.getTheme());\n                editor.gotoLine(0, 0);\n                editor.setReadOnly(readOnly);\n                session.setUseSoftTabs(true);\n                session.setTabSize(4);\n                // Avoid undo of editor initial content.\n                session.setUndoManager(new ace.UndoManager());\n                this.setOpen(true);\n                this.langSelection();\n                // Code to control Paste and drop under restricted editing.\n                editor.execCommand('replace');\n                var addEventDrop = function() {\n                    var tag = $(tid + ' div.ace_search');\n                    if (tag.length) {\n                        tag.on('drop', fileManager.dropHandler);\n                        var button = $('.ace_searchbtn_close');\n                        button.trigger('click');\n                    } else {\n                        setTimeout(addEventDrop, 50);\n                    }\n                };\n                editor.on('change', function() {\n                    self.change();\n                });\n                // Try to grant dropHandler installation.\n                setTimeout(addEventDrop, 5);\n                // Save previous onPaste and change for a new one.\n                var prevOnPaste = editor.onPaste;\n                editor.onPaste = function(s) {\n                    if (fileManager.restrictedEdit) {\n                        editor.insert(fileManager.getClipboard());\n                    } else {\n                        prevOnPaste.call(editor, s);\n                    }\n                };\n                // Control copy and cut (yes cut also use this) for localClipboard.\n                editor.on('copy', function(t) {\n                    fileManager.setClipboard(t);\n                });\n                $(tid).on('paste', '*', fileManager.restrictedPaste);\n                $(tid + ' div.ace_content').on('drop', fileManager.dropHandler);\n                $(tid + ' div.ace_content').on('dragover', fileManager.dragoverHandler);\n                this.adjustSize();\n                return editor;\n            };\n            this.close = function() {\n                this.setOpen(false);\n                if (editor === null) {\n                    return;\n                }\n                this.setContent(editor.getValue());\n                editor.destroy();\n                editor = null;\n                session = null;\n            };\n        };\n    }\n);\n"],"file":"vplidecodefile.min.js"}