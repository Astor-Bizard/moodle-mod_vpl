define(["jquery","jqueryui","mod_vpl/vplutil"],function(g,t,p){if(void 0!==f)return f;var f=function(s,t,r,a,l){var c="#vpl_file"+s,n="#vpl_tab_name"+s,u=t,i=!0,h=!1,d=this;this.getId=function(){return s},this.getTabNameId=function(){return n},this.getTId=function(){return c},this.getFileName=function(){return u},this.resetModified=function(){i=!1,this.setFileName(u)},this.getTabPos=function(){return a.getTabPos(this)},this.isOpen=function(){return h},this.isModified=function(){return i},this.change=function(){i||(i=!0,a.generateFileList(),this.setFileName(u)),p.longDelay("setModified",a.setModified)},this.setFileName=function(t){if(!p.validPath(t))return!1;if(t!=u&&(u=t,d.change()),!h)return!0;var e=p.getFileName(t);20<e.length&&(e=e.substring(0,16)+"...");var o=(i?p.iconModified():"")+e;return this.getTabPos()<a.minNumberOfFiles?o+=p.iconRequired():o+=p.iconClose(),g(n+" a").html(o),e!=t&&g(n+" a").attr("title",t),i&&a.adjustTabsTitles(!1),this.langSelection(),!0},this.getContent=function(){return r},this.setContent=function(t){r=t},this.destroy=function(){g(n).remove(),g(c).remove()},this.adjustSize=function(){if(!h)return!1;var t=g(c),e=t.parent();if(0===t.length)return!1;var o=t.height(),n=t.width(),i=e.height();i-=t.position().top;var s=g("#vpl_tabs_scroll").width();return(i!=o||s!=n)&&(g(t).height(i),g(t).width(s),!0)},this.gotoLine=p.doNothing,this.setReadOnly=p.doNothing,this.focus=p.doNothing,this.blur=p.doNothing,this.undo=p.doNothing,this.redo=p.doNothing,this.selectAll=p.doNothing,this.open=p.doNothing,this.hasUndo=p.returnFalse,this.hasRedo=p.returnFalse,this.hasSelectAll=p.returnFalse,this.hasFind=p.returnFalse,this.hasFindReplace=p.returnFalse,this.hasNext=p.returnFalse,this.find=p.doNothing,this.replace=p.doNothing,this.next=p.doNothing,this.getAnnotations=function(){return[]},this.setAnnotations=p.doNothing,this.setFontSize=p.doNothing,this.setTheme=p.doNothing,this.clearAnnotations=p.doNothing,this.langSelection=p.doNothing,this.isBinary=function(){return!1},this.extendToCodeEditor=function(){var o=null,n=null,i=a.readOnly;this.getContent=function(){return h?o.getValue():r},this.setContent=function(t){r=t,h&&o.setValue(t)},this.oldDestroy=this.destroy,this.destroy=function(){h&&o.destroy(),this.oldDestroy()},this.setFontSize=function(t){h&&o.setFontSize(t)},this.oldAdjustSize=this.adjustSize,this.adjustSize=function(){return!!this.oldAdjustSize()&&(o.resize(),!0)},this.gotoLine=function(t){h&&(o.gotoLine(t,0),o.scrollToLine(t,!0),o.focus())},this.setReadOnly=function(t){i=t,h&&o.setReadOnly(t)},this.focus=function(){h&&(g(c).removeClass("ui-widget-content ui-tabs-panel"),g(c).addClass("ui-corner-bottom"),this.adjustSize(),o.focus())},this.blur=function(){h&&o.blur()},this.undo=function(){h&&(o.undo(),o.focus())},this.redo=function(){h&&(o.redo(),o.focus())},this.selectAll=function(){h&&(o.selectAll(),o.focus())},this.hasUndo=function(){return!!h&&n.getUndoManager().hasUndo()},this.hasRedo=function(){return!!h&&n.getUndoManager().hasRedo()},this.hasSelectAll=p.returnTrue,this.hasFind=p.returnTrue,this.hasFindReplace=p.returnTrue,this.hasNext=p.returnTrue,this.find=function(){h&&o.execCommand("find")},this.replace=function(){h&&o.execCommand("replace")},this.next=function(){h&&o.execCommand("findnext")},this.getAnnotations=function(){return h?n.getAnnotations():[]},this.setAnnotations=function(t){return!!h&&n.setAnnotations(t)},this.clearAnnotations=function(){return!!h&&n.clearAnnotations()},this.langSelection=function(){var t,e;h&&(e="text",""!==(t=p.fileExtension(u))&&(e=p.langType(t)),n.setMode("ace/mode/"+e))},this.getEditor=function(){return!!h&&o},this.setTheme=function(t){h&&o.setTheme("ace/theme/"+t)},this.open=function(){if("undefined"==typeof ace)return p.loadScript(["../editor/ace9/ace.js","../editor/ace9/ext-language_tools.js"],function(){d.open()}),!1;if(h)return!1;g(c).removeClass("ui-widget-content ui-tabs-panel"),g(c).addClass("ui-corner-bottom"),ace.require("ext/language_tools"),h=!0,o=ace.edit("vpl_file"+s),n=o.getSession(),o.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),o.setFontSize(a.getFontSize()),o.setTheme("ace/theme/"+a.getTheme()),this.setFileName(u),o.setValue(r),o.gotoLine(0,0),o.setReadOnly(i),n.setUseSoftTabs(!0),n.setTabSize(4),n.setUndoManager(new ace.UndoManager),o.execCommand("replace"),o.on("change",function(){d.change()}),setTimeout(function t(){var e=g(c+" div.ace_search");e.length?(e.on("drop",a.dropHandler),g(".ace_searchbtn_close").trigger("click")):setTimeout(t,50)},5);var e=o.onPaste;return o.onPaste=function(t){a.restrictedEdit?o.insert(a.getClipboard()):e.call(o,t)},o.on("copy",function(t){a.setClipboard(t)}),g(c).on("paste","*",a.restrictedPaste),g(c+" div.ace_content").on("drop",a.dropHandler),g(c+" div.ace_content").on("dragover",a.dragoverHandler),this.adjustSize(),o},this.close=function(){h=!1,null!==o&&(r=o.getValue(),o.destroy(),n=o=null)}},this.adaptBlockly=function(){void 0===Blockly.PHP.workspaceToCodeOld&&(Blockly.PHP.workspaceToCodeOld=Blockly.PHP.workspaceToCode,Blockly.PHP.workspaceToCode=function(t){return"<?\n"+Blockly.PHP.workspaceToCodeOld(t)}),void 0===Blockly.Python.workspaceToCodeOld&&(Blockly.Python.workspaceToCodeOld=Blockly.Python.workspaceToCode,Blockly.Python.workspaceToCode=function(t){return"# -*- coding: utf-8 -*-\n"+Blockly.Python.workspaceToCodeOld(t)})},this.extendToBlockly=function(){this.firstFocus=!0,this.workspacePlayground=!1,this.focus=function(){d.firstFocus&&(d.workspacePlayground?(d.firstFocus=!1,Blockly.Events.disable(),d.setContent(r),p.adjustBlockly(d.workspacePlayground,10,10),d.workspacePlayground.scrollX=0,d.workspacePlayground.scrollY=0,Blockly.svgResize(d.workspacePlayground),Blockly.resizeSvgContents(d.workspacePlayground),d.adjustSize(),Blockly.Events.enable()):p.longDelay("focus",d.focus))},this.adjustSize=function(){if(!h||!this.workspacePlayground)return!1;var t=g(c);if(0===t.length)return!1;var e=t.parent().height();return e-=t.position().top,t.height(e),g("#"+this.bdiv).height(e),g("#"+this.bdiv).width(t.width()),Blockly.svgResize(this.workspacePlayground),!1},this.undo=function(){h&&this.workspacePlayground.undo(!1)},this.redo=function(){h&&this.workspacePlayground.undo(!0)},this.interpreter=!1,this.animateRun=!1,this.RUNSTATE=1,this.STEPSTATE=2,this.STOPSTATE=3,this.executionState=this.STOPSTATE,this.goNext=!1,this.initRun=function(t){var n=l.getTerminal();n.isConnected()&&n.closeLocal(),this.animateRun=t,Blockly.JavaScript.STATEMENT_PREFIX="highlightBlock(%1);\n",Blockly.JavaScript.addReservedWords("highlightBlock");var e=Blockly.JavaScript.workspaceToCode(d.workspacePlayground);d.interpreter=new Interpreter(e,function(e,t){var o=function(t){return t=t?t.toString()+"\r\n":t+"\r\n",e.createPrimitive(n.writeLocal(t))};e.setProperty(t,"alert",e.createNativeFunction(o)),o=function(t,e){t=t?t.toString():""+t,n.writeLocal(t),n.setDataCallback(function(t){n.writeLocal("\n"),e(t)})},e.setProperty(t,"prompt",e.createAsyncFunction(o)),o=function(t){t==d.breakpoint&&(d.executionState=d.STEPSTATE,d.updateRunButtons(),l.getTerminal().setMessage(p.str("breakpoint"))),!d.animateRun&&d.executionState!=d.STEPSTATE||d.workspacePlayground.highlightBlock(t),d.goNext=!1},e.setProperty(t,"highlightBlock",e.createNativeFunction(o))}),n.connectLocal(d.stop,function(){})},this.reservedWords={Infinity:!0,Array:!0,Boolean:!0,Date:!0,Error:!0,EvalError:!0,Function:!0,JSON:!0,Math:!0,NaN:!0,Number:!0,Object:!0,RangeError:!0,ReferenceError:!0,RegExp:!0,String:!0,SyntaxError:!0,TypeError:!0,URIError:!0,alert:!0,arguments:!0,constructor:!0,eval:!0,highlightBlock:!0,isFinite:!0,isNaN:!0,parseFloat:!0,parseInt:!0,prompt:!0,self:!0,this:!0,window:!0},this.breakpoint="",this.getVarValue=function(t){var e="";if(null===t)e="<b>null</b>";else if(null!=t){var o=typeof t;if("string"==o)e='"'+p.sanitizeText(t)+'"';else if("boolean"==o)e="<b>"+t+"</b>";else if("object"==o&&"Array"===t.class){e="[";for(var n=t.properties,i=0;i<n.length;i++)e+=d.getVarValue(n[i]),i!=n.length-1&&(e+=", ");e+="]"}else"object"==o?e="<b>"+t.toString()+"</b>":e+=""+t}return e},this.getVariables=function(t){var e,o="";for(var n in t){!0!==this.reservedWords[n]&&(null!=(e=t[n])&&"Function"!==e.class&&(o+="<b>"+n+"</b>:&nbsp;"+d.getVarValue(e)+"<br>\n"))}return o},this.getParameters=function(t){for(var e="(",o=0;o<t.length;o++)e+=""+t[o],o<t.length-1&&(e+=", ");return e+")"},this.showStack=function(t){for(var e=0,o='<table class="generaltable">',n=t.stateStack,i="<tr><td>0</td><td><b>Globals</b></td>",s=0;s<n.length;s++){var r=n[s];""<i&&("CallExpression"==r.node.type||s==n.length-1)&&(o+=i+"<td>"+d.getVariables(r.scope.properties),o+="</td></tr>"),"CallExpression"==r.node.type&&(!0!==d.reservedWords[r.node.callee.name]&&null!=r.node.callee.name?(i="<tr><td>"+ ++e+"</td>",i+="<td>"+r.node.callee.name+d.getParameters(r.arguments_)+"</td>"):i="")}o+="</table>",l.setResult({variables:o})},this.runLoop=function(){if(d.interpreter){d.goNext=!0;for(var t=0;t<3e4&&d.goNext&&d.executionState!=d.STOPSTATE;t++)if(!d.interpreter||!d.interpreter.step()){d.executionState=d.STOPSTATE,d.updateRunButtons();break}if(d.executionState==d.STOPSTATE)return d.workspacePlayground.highlightBlock(-1),l.getTerminal().closeLocal(),void l.setResult({variables:""});d.executionState==d.RUNSTATE?d.animateRun?(setTimeout(d.runLoop,1e3),d.showStack(d.interpreter)):setTimeout(d.runLoop,0):d.showStack(d.interpreter)}},this.start=function(){d.initRun(!1),d.executionState=d.RUNSTATE,d.updateRunButtons(),l.getTerminal().setMessage(p.str("start")),d.runLoop()},this.startAnimate=function(){d.initRun(!0),d.executionState=d.RUNSTATE,d.updateRunButtons(),l.getTerminal().setMessage(p.str("startanimate")),d.runLoop()},this.stop=function(){d.executionState=d.STOPSTATE,d.updateRunButtons(),l.getTerminal().setMessage(p.str("stop")),l.getTerminal().closeLocal(),d.interpreter=!1,l.setResult({variables:""})},this.pause=function(){d.executionState=d.STEPSTATE,l.getTerminal().setMessage(p.str("pause")),d.updateRunButtons()},this.resume=function(){d.executionState=d.RUNSTATE,l.getTerminal().setMessage(p.str("resume")),d.updateRunButtons(),d.runLoop()},this.step=function(){d.executionState==d.STOPSTATE&&d.initRun(!0),d.executionState=d.STEPSTATE,d.updateRunButtons(),l.getTerminal().setMessage(p.str("step")),d.runLoop()},this.hasUndo=function(){return!0},this.hasRedo=function(){return!0},this.oldSetFileName=this.setFileName,this.generatorMap={py:"Python",dart:"Dart",js:"JavaScript",lua:"Lua",php:"PHP"},this.generator="",this.setFileName=function(t){var e=p.fileExtension(u);d.oldSetFileName(t);var o=/\.([^.]+)\.blockly[123]?$/.exec(u),n=/(.+)\.blockly[123]?$/.exec(u);null!==o&&null!==n&&"string"==typeof this.generatorMap[o[1]]?(this.generator=this.generatorMap[o[1]],this.generatedFilename=n[1]):this.generator="",null!==n&&e!=p.fileExtension(u)&&this.setToolbox()},this.changeCode=function(t){var e,o,n;"ui"!=t.type||"selected"!=t.element?"ui"!=t.type||"category"!=t.element||t.newValue!=p.str("run")?t.recordUndo&&(d.change(),""!=this.generator&&(e=Blockly[this.generator].workspaceToCode(d.workspacePlayground),-1==(o=a.fileNameExists(this.generatedFilename))&&(a.addFile({name:this.generatedFilename,contents:""},!1,p.doNothing,p.doNothing),o=a.fileNameExists(this.generatedFilename)),-1!=o&&((n=a.getFile(o)).setContent(e),n.change(),n.gotoLine(1),n.setReadOnly(!0)))):d.updateRunButtons():d.breakpoint=t.newValue},this.updateRunButtons=function(){switch(d.executionState){case d.RUNSTATE:g(".blocklyStartC").hide(),g(".blocklyStartAnimateC").hide(),g(".blocklyStopC").show(),g(".blocklyPauseC").show(),g(".blocklyResumeC").hide(),g(".blocklyStepC").hide();break;case d.STEPSTATE:g(".blocklyStartC").hide(),g(".blocklyStartAnimateC").hide(),g(".blocklyStopC").show(),g(".blocklyPauseC").hide(),g(".blocklyResumeC").show(),g(".blocklyStepC").show();break;case d.STOPSTATE:g(".blocklyStartC").show(),g(".blocklyStartAnimateC").show(),g(".blocklyStopC").hide(),g(".blocklyPauseC").hide(),g(".blocklyResumeC").hide(),g(".blocklyStepC").show()}},this.setToolbox=function(){var e=p.fileExtension(u)+"Toolbox";!1!==f[e]?(this.workspacePlayground.updateToolbox(f[e]),this.workspacePlayground.registerButtonCallback("blocklyStartButton",this.start),this.workspacePlayground.registerButtonCallback("blocklyStartAnimateButton",this.startAnimate),this.workspacePlayground.registerButtonCallback("blocklyStopButton",this.stop),this.workspacePlayground.registerButtonCallback("blocklyPauseButton",this.pause),this.workspacePlayground.registerButtonCallback("blocklyResumeButton",this.resume),this.workspacePlayground.registerButtonCallback("blocklyStepButton",this.step),this.adjustSize()):g.ajax({url:"../editor/blocklytoolboxes/"+e+".xml",dataType:"text",success:function(t){f[e]=f.blocklyIn18(t),d.setToolbox()}})},this.open=function(){if(h=!0,this.setFileName(u),h=!1,f.blocklyNotLoaded)return p.loadScript(["../editor/blockly/blockly_compressed.js","../editor/blockly/msg/js/en.js","../editor/blockly/blocks_compressed.js","../editor/blockly/python_compressed.js","../editor/blockly/javascript_compressed.js","../editor/blockly/php_compressed.js","../editor/blockly/lua_compressed.js","../editor/blockly/dart_compressed.js","../editor/acorn/acorn.js","../editor/acorn/interpreter.js"],function(){d.adaptBlockly(),f.blocklyNotLoaded=!1,d.open()}),!1;var t=!(h=!0);/.*[0-9]$/.test(p.fileExtension(u))&&(t=!0),g(c).removeClass("ui-widget-content ui-tabs-panel"),g(c).addClass("ui-corner-bottom"),this.bdiv="bkdiv"+s,g(c).html('<div id="'+this.bdiv+'" style="height: 480px; width: 600px;"></div>');var e={toolbox:'<xml><category name=""><block type="math_number"></block></category></xml>',media:"../editor/blockly/media/",horizontalLayout:t,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.2,scaleSpeed:1.15}};return this.workspacePlayground=Blockly.inject(this.bdiv,e),this.workspacePlayground.addChangeListener(function(t){d.changeCode(t)}),this.setToolbox(),!1},this.getContent=function(){if(!h)return r;var t=Blockly.Xml.workspaceToDom(this.workspacePlayground);return Blockly.Xml.domToPrettyText(t)},this.setContent=function(t){var e;r=t,h&&(this.workspacePlayground.clear(),e=Blockly.Xml.textToDom(t),Blockly.Xml.domToWorkspace(e,this.workspacePlayground))},this.close=function(){r=this.getContent(),this.workspacePlayground.dispose(),this.workspacePlayground=!1,this.firstFocus=!0,h=!1}},this.extendToBinary=function(){this.isBinary=function(){return!0},this.setContent=function(t){i=!0,r=t,this.setFileName(u),this.updateDataURL()},this.updateDataURL=function(){var t;p.isImage(u)?(t="data:"+p.getMIME(u)+";base64,",g(c).find("img").attr("src",t+r)):g(c).find("img").attr("src","")},this.adjustSize=function(){if(!h)return!1;var t=g(c);if(0===t.length)return!1;var e=t.parent().height();return(e-=t.position().top)!=t.height()&&(t.height(e),!0)},this.open=function(){return h=!0,p.isImage(u)?(g(c).addClass("vpl_ide_img").append("<img />"),this.updateDataURL()):g(c).addClass("vpl_ide_binary").text(p.str("binaryfile")),this.setFileName(u),!1},this.close=function(){h=!1}}};return f.blocklyNotLoaded=!0,f.blocklyToolbox=!1,f.blockly0Toolbox=!1,f.blockly1Toolbox=!1,f.blockly2Toolbox=!1,f.blockly3Toolbox=!1,f.blocklyStrs=["basic","intermediate","advanced","variables","operatorsvalues","control","inputoutput","functions","lists","math","text","run","start","startanimate","stop","pause","resume","step"],f.blocklyIn18=function(t){for(var e=f.blocklyStrs.length,o=0;o<e;o++){var n=f.blocklyStrs[o],i=new RegExp("\\[\\["+n+"\\]\\]","g"),s=p.str(n);t=t.replace(i,s)}return t},window.VPLFile=f});