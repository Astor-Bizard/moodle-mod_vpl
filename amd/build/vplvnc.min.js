define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard","core/log"],function(a,b,c,d,e){window.INCLUDE_URI="../editor/noVNC/include/",Util.load_scripts(["webutil.js","base64.js","websock.js","des.js","keysymdef.js","keyboard.js","input.js","display.js","jsunzip.js","rfb.js","keysym.js"]);var f=function(b,f){function g(){var a=D.value;if(a!=F||a!=E){var b=Math.min(a.length,F.length),c=0;for(c=0;c<b&&a.charAt(c)==F.charAt(c);c++);for(var d=F.length-1;d>=a.length;d--)u.sendBackspace();c<a.length&&u.send(a.substr(c)),F=a,(a.length>500||0===a.length)&&(D.blur(),setTimeout(function(){D.focus(),D.value=E,F=E;try{D.setSelectionRange(E.length,E.length)}catch(a){}},10))}}function h(){a(D).is(":focus")?D.blur():D.focus()}function i(){u.isConnected()&&r.clipboardPasteFrom(s.getEntry2())}function j(a,b){s.setEntry1(b)}function k(){s.show()}function l(){u.isConnected()&&r.get_keyboard().set_focused(!0)}function m(){u.isConnected()&&r.get_keyboard().set_focused(!1)}function n(){s.setEntry1(s.getEntry1()),document.execCommand("copy")}function o(){var a=z.width(),b=z.height();y.width()>a&&(C=!0,y.dialog("option","width",a)),y.parent().height()>b&&(C=!0,y.dialog("option","height",b-y.prev().outerHeight()))}function p(a,b,c,d){switch(x=b,b){case"normal":u.setMessage(""),u.setTitle(f("connected"));break;case"disconnect":case"disconnected":u.setTitle(f("connection_closed"));break;case"failed":u.setTitle(f("connection_fail")),e.log("VNC client: "+d);break;default:u.setMessage(""),u.setTitle(f("connecting"))}}function q(a){return a<100&&(a=100),2*Math.floor(a/2)}var r,s,t,u=this,v="",w="",x="",y=a("#"+b),z=a("#vplide"),A=a("#"+b+" canvas"),B=function(){},C=!0,D=window.document.createElement("input");D.style.position="absolute",D.style.left="0px",D.style.top="-10000px",D.style.width="1em",D.style.height="1ex",D.style.opacity="0",D.style.backgroundColor="transparent",D.style.borderStyle="none",D.style.outlineStyle="none",D.autocapitalize="off",D.autocomplete="off",D.autocorrect="off",D.wrap="off",D.spellcheck="false",y.append(D);var E="_________________________________________________________",F=E;if(c.isAndroid()&&c.isFirefox()){this.send=function(a){for(var b=0;b<a.length;b++)r.sendKey(a.charCodeAt(b))},this.sendBackspace=function(){r.sendKey(65288)},D.value=E,D.focus();try{D.setSelectionRange(E.length,E.length)}catch(G){}a(D).on("change",function(){g(),u.send("\r")}),a(D).on("input",function(){g()}),a(D).on("keypress",function(a){a.stopImmediatePropagation()}),a(D).on("focus",function(){D.value=E,F=E;try{D.setSelectionRange(E.length,E.length)}catch(a){}})}var H=c.genIcon("copy","sw")+" "+f("copy"),I=c.genIcon("paste","sw")+" "+f("paste");s=new d("vpl_dialog_vnc_clipboard",H,n,I,i,m),A.on("click",function(a){a.target==A[0]?l():m()}),this.displayResize=function(){if(u.isConnected()){var a=y.width(),b=y.height();u.setCanvasSize(a,b),r.get_display().viewportChange(0,0,a,b)}},y.dialog({closeOnEscape:!1,autoOpen:!1,modal:!0,width:"auto",height:"auto",dialogClass:"vpl_ide vpl_vnc",create:function(){t=c.setTitleBar(y,"vnc","graphic",["clipboard","keyboard"],[k,h])},dragStop:o,focus:l,open:o,beforeClose:function(){if(C){var a=y.width(),b=y.height();C=!1,u.setCanvasSize(a,b)}},close:function(){u.disconnect()},resizeStop:function(){o(),C=!0}}),y.css("padding","1px"),this.updateTitle=function(){var a=v;""!==w&&(a+=" ("+w+")"),t.text(f("console")+": "+a)},this.setTitle=function(a){v=a,this.updateTitle()},this.setMessage=function(a){w=a,this.updateTitle()},this.connect=function(c,d,e,f,g,h){s.setEntry1(""),B=h,u.show();var i=a("#"+b+" canvas")[0];r||(r=new RFB({target:i,encrypt:c,repeaterID:"",true_color:!0,local_cursor:!0,shared:!1,view_only:!1,onUpdateState:p,onPasswordRequired:null,onClipboard:j}),r.set_local_cursor(r.get_display().get_cursor_uri())),e||(e=c?443:80),r.connect(d,e,f,g)},this.isOpen=function(){return y.dialog("isOpen")},this.close=function(){y.dialog("close")},this.isConnected=function(){return r&&"disconnected"!=x},this.disconnect=function(){r&&"normal"==x&&r.disconnect(),B(),s.hide()},this.getCanvasSize=function(){return A.width()+"x"+A.height()},this.setCanvasSize=function(a,b){A.width(q(a)),A.height(q(b))},this.show=function(){y.dialog("open"),y.width("auto"),y.height("auto")},u.setCanvasSize(a(window).width()-150,a(window).height()-150)};return f});