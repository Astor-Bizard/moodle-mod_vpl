define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard","core/log"],function(S,e,z,T,E){window.INCLUDE_URI="../editor/noVNC/include/",Util.load_scripts(["webutil.js","base64.js","websock.js","des.js","keysymdef.js","keyboard.js","input.js","display.js","jsunzip.js","rfb.js","keysym.js"]);return function(a,i){var l,d,t,r=this,n="",o="",s="",c=S("#"+a),u=S("#vplide"),h=S("#"+a+" canvas"),p=z.doNothing,f=!0,e=window.document.createElement("input");function g(){S(e).is(":focus")?e.blur():e.focus()}function y(e,t){d.setEntry1(t)}function w(){d.show()}function v(){r.isConnected()&&l.get_keyboard().set_focused(!0)}function _(){r.isConnected()&&l.get_keyboard().set_focused(!1)}e.style.position="absolute",e.style.left="0px",e.style.top="-10000px",e.style.width="1em",e.style.height="1ex",e.style.opacity="0",e.style.backgroundColor="transparent",e.style.borderStyle="none",e.style.outlineStyle="none",e.autocapitalize="off",e.autocomplete="off",e.autocorrect="off",e.wrap="off",e.spellcheck="false",c.append(e);var b=z.genIcon("copy","sw")+" "+i("copy"),C=z.genIcon("paste","sw")+" "+i("paste");function m(){var e=u.width(),t=u.height();c.width()>e&&(f=!0,c.dialog("option","width",e)),c.parent().height()>t&&(f=!0,c.dialog("option","height",t-c.prev().outerHeight()))}function j(e,t,n,o){switch(s=t){case"normal":r.setMessage(""),r.setTitle(i("connected"));break;case"disconnect":case"disconnected":r.setTitle(i("connection_closed"));break;case"failed":r.setTitle(i("connection_fail")),E.log("VNC client: "+o);break;default:r.setMessage(""),r.setTitle(i("connecting"))}}function k(e){return e<100&&(e=100),2*Math.floor(e/2)}d=new T("vpl_dialog_vnc_clipboard",b,function(){d.setEntry1(d.getEntry1()),document.execCommand("copy")},C,function(){r.isConnected()&&l.clipboardPasteFrom(d.getEntry2())},_),h.on("click",function(e){(e.target==h[0]?v:_)()}),this.displayResize=function(){var e,t;r.isConnected()&&(e=c.width(),t=c.height(),r.setCanvasSize(e,t),l.get_display().viewportChange(0,0,e,t))},c.dialog({closeOnEscape:!1,autoOpen:!1,modal:!0,width:"auto",height:"auto",dialogClass:"vpl_ide vpl_vnc",create:function(){t=z.setTitleBar(c,"vnc","graphic",["clipboard","keyboard"],[w,g])},dragStop:m,focus:v,open:m,beforeClose:function(){var e,t;f&&(e=c.width(),t=c.height(),f=!1,r.setCanvasSize(e,t))},close:function(){r.disconnect()},resizeStop:function(){m(),f=!0}}),c.css("padding","1px"),this.updateTitle=function(){var e=n;""!==o&&(e+=" ("+o+")"),t.text(i("console")+": "+e)},this.setTitle=function(e){n=e,this.updateTitle()},this.setMessage=function(e){o=e,this.updateTitle()},this.connect=function(e,t,n,o,i,s){d.setEntry1(""),p=s,r.show();var c=S("#"+a+" canvas")[0];l||(l=new RFB({target:c,encrypt:e,repeaterID:"",true_color:!0,local_cursor:!0,shared:!1,view_only:!1,onUpdateState:j,onPasswordRequired:null,onClipboard:y})).set_local_cursor(l.get_display().get_cursor_uri()),n=n||(e?443:80),l.connect(t,n,o,i)},this.isOpen=function(){return c.dialog("isOpen")},this.close=function(){c.dialog("close")},this.isConnected=function(){return l&&"disconnected"!=s},this.disconnect=function(){l&&"normal"==s&&l.disconnect(),p(),d.hide()},this.getCanvasSize=function(){return h.width()+"x"+h.height()},this.setCanvasSize=function(e,t){h.width(k(e)),h.height(k(t))},this.show=function(){c.dialog("open"),c.width("auto"),c.height("auto")},r.setCanvasSize(S(window).width()-150,S(window).height()-150)}});