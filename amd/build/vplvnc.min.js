define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard","core/log"],function(x,e,E,R,I){window.INCLUDE_URI="../editor/noVNC/include/",Util.load_scripts(["webutil.js","base64.js","websock.js","des.js","keysymdef.js","keyboard.js","input.js","display.js","jsunzip.js","rfb.js","keysym.js"]);return function(a,i){var l,r,t,d=this,n="",o="",s="",c=x("#"+a),u=x("#vplide"),h=x("#"+a+" canvas"),_=function(){},f=!0,p=window.document.createElement("input");p.style.position="absolute",p.style.left="0px",p.style.top="-10000px",p.style.width="1em",p.style.height="1ex",p.style.opacity="0",p.style.backgroundColor="transparent",p.style.borderStyle="none",p.style.outlineStyle="none",p.autocapitalize="off",p.autocomplete="off",p.autocorrect="off",p.wrap="off",p.spellcheck="false",c.append(p);var g="_________________________________________________________",y=g;function e(){var e=p.value;if(e!=y||e!=g){for(var t=Math.min(e.length,y.length),n=0,n=0;n<t&&e.charAt(n)==y.charAt(n);n++);for(var o=y.length-1;o>=e.length;o--)d.sendBackspace();n<e.length&&d.send(e.substr(n)),(500<(y=e).length||0===e.length)&&(p.blur(),setTimeout(function(){p.focus(),p.value=g,y=g;try{p.setSelectionRange(g.length,g.length)}catch(e){}},10))}}if(E.isAndroid()&&E.isFirefox()){this.send=function(e){for(var t=0;t<e.length;t++)l.sendKey(e.charCodeAt(t))},this.sendBackspace=function(){l.sendKey(65288)},p.value=g,p.focus();try{p.setSelectionRange(g.length,g.length)}catch(e){}x(p).on("change",function(){e(),d.send("\r")}),x(p).on("input",function(){e()}),x(p).on("keypress",function(e){e.stopImmediatePropagation()}),x(p).on("focus",function(){p.value=g,y=g;try{p.setSelectionRange(g.length,g.length)}catch(e){}})}function v(){x(p).is(":focus")?p.blur():p.focus()}function w(e,t){r.setEntry1(t)}function b(){r.show()}function C(){d.isConnected()&&l.get_keyboard().set_focused(!0)}function m(){d.isConnected()&&l.get_keyboard().set_focused(!1)}var k=E.genIcon("copy","sw")+" "+i("copy"),j=E.genIcon("paste","sw")+" "+i("paste");function S(){var e=u.width(),t=u.height();c.width()>e&&(f=!0,c.dialog("option","width",e)),c.parent().height()>t&&(f=!0,c.dialog("option","height",t-c.prev().outerHeight()))}function T(e,t,n,o){switch(s=t){case"normal":d.setMessage(""),d.setTitle(i("connected"));break;case"disconnect":case"disconnected":d.setTitle(i("connection_closed"));break;case"failed":d.setTitle(i("connection_fail")),I.log("VNC client: "+o);break;default:d.setMessage(""),d.setTitle(i("connecting"))}}function z(e){return e<100&&(e=100),2*Math.floor(e/2)}r=new R("vpl_dialog_vnc_clipboard",k,function(){r.setEntry1(r.getEntry1()),document.execCommand("copy")},j,function(){d.isConnected()&&l.clipboardPasteFrom(r.getEntry2())},m),h.on("click",function(e){(e.target==h[0]?C:m)()}),this.displayResize=function(){var e,t;d.isConnected()&&(e=c.width(),t=c.height(),d.setCanvasSize(e,t),l.get_display().viewportChange(0,0,e,t))},c.dialog({closeOnEscape:!1,autoOpen:!1,modal:!0,width:"auto",height:"auto",dialogClass:"vpl_ide vpl_vnc",create:function(){t=E.setTitleBar(c,"vnc","graphic",["clipboard","keyboard"],[b,v])},dragStop:S,focus:C,open:S,beforeClose:function(){var e,t;f&&(e=c.width(),t=c.height(),f=!1,d.setCanvasSize(e,t))},close:function(){d.disconnect()},resizeStop:function(){S(),f=!0}}),c.css("padding","1px"),this.updateTitle=function(){var e=n;""!==o&&(e+=" ("+o+")"),t.text(i("console")+": "+e)},this.setTitle=function(e){n=e,this.updateTitle()},this.setMessage=function(e){o=e,this.updateTitle()},this.connect=function(e,t,n,o,i,s){r.setEntry1(""),_=s,d.show();var c=x("#"+a+" canvas")[0];l||(l=new RFB({target:c,encrypt:e,repeaterID:"",true_color:!0,local_cursor:!0,shared:!1,view_only:!1,onUpdateState:T,onPasswordRequired:null,onClipboard:w})).set_local_cursor(l.get_display().get_cursor_uri()),n=n||(e?443:80),l.connect(t,n,o,i)},this.isOpen=function(){return c.dialog("isOpen")},this.close=function(){c.dialog("close")},this.isConnected=function(){return l&&"disconnected"!=s},this.disconnect=function(){l&&"normal"==s&&l.disconnect(),_(),r.hide()},this.getCanvasSize=function(){return h.width()+"x"+h.height()},this.setCanvasSize=function(e,t){h.width(z(e)),h.height(z(t))},this.show=function(){c.dialog("open"),c.width("auto"),c.height("auto")},d.setCanvasSize(x(window).width()-150,x(window).height()-150)}});