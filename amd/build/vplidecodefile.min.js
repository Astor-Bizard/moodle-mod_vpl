define(["jquery","mod_vpl/vplutil"],function(c,u){return function(){var o=this,a=null,r=null,h=o.getFileManager().readOnly,e=this.getContent;this.getContent=function(){return this.isOpen()?a.getValue():e.call(this)};var t=this.setContent;this.setContent=function(e){t.call(this,e),this.isOpen()&&a.setValue(e)};var n=this.destroy;this.destroy=function(){this.isOpen()&&a.destroy(),n.call(this)},this.setFontSize=function(e){this.isOpen()&&a.setFontSize(e)};var i=this.adjustSize;this.adjustSize=function(){return!!i.call(this)&&(a.resize(),!0)},this.gotoLine=function(e){this.isOpen()&&(a.gotoLine(e,0),a.scrollToLine(e,!0),a.focus())},this.setReadOnly=function(e){h=e,this.isOpen()&&a.setReadOnly(e)},this.focus=function(){var e;this.isOpen()&&(e=this.getTId(),c(e).removeClass("ui-widget-content ui-tabs-panel"),c(e).addClass("ui-corner-bottom"),this.adjustSize(),a.focus())},this.blur=function(){this.isOpen()&&a.blur()},this.undo=function(){this.isOpen()&&(a.undo(),a.focus())},this.redo=function(){this.isOpen()&&(a.redo(),a.focus())},this.selectAll=function(){this.isOpen()&&(a.selectAll(),a.focus())},this.hasUndo=function(){return!!this.isOpen()&&r.getUndoManager().hasUndo()},this.hasRedo=function(){return!!this.isOpen()&&r.getUndoManager().hasRedo()},this.hasSelectAll=u.returnTrue,this.hasFind=u.returnTrue,this.hasFindReplace=u.returnTrue,this.hasNext=u.returnTrue,this.find=function(){this.isOpen()&&a.execCommand("find")},this.replace=function(){this.isOpen()&&a.execCommand("replace")},this.next=function(){this.isOpen()&&a.execCommand("findnext")},this.getAnnotations=function(){return this.isOpen()?r.getAnnotations():[]},this.setAnnotations=function(e){return!!this.isOpen()&&r.setAnnotations(e)},this.clearAnnotations=function(){return!!this.isOpen()&&r.clearAnnotations()},this.langSelection=function(){var e,t;this.isOpen()&&(t="text",""!==(e=u.fileExtension(this.getFileName()))&&(t=u.langType(e)),r.setMode("ace/mode/"+t))},this.getEditor=function(){return!!this.isOpen()&&a},this.setTheme=function(e){this.isOpen()&&a.setTheme("ace/theme/"+e)},this.open=function(){if("undefined"==typeof ace)return u.loadScript(["../editor/ace9/ace.js","../editor/ace9/ext-language_tools.js"],function(){o.open()}),!1;if(this.isOpen())return!1;var e=this.getFileName(),t=this.getFileManager(),n=this.getTId();c(n).removeClass("ui-widget-content ui-tabs-panel"),c(n).addClass("ui-corner-bottom"),ace.require("ext/language_tools"),a=ace.edit("vpl_file"+this.getId()),r=a.getSession(),a.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),a.setValue(this.getContent()),this.setOpen(!0),a.setFontSize(t.getFontSize()),a.setTheme("ace/theme/"+t.getTheme()),this.setFileName(e),a.gotoLine(0,0),a.setReadOnly(h),r.setUseSoftTabs(!0),r.setTabSize(4),r.setUndoManager(new ace.UndoManager),a.execCommand("replace");var i=function(){var e=c(n+" div.ace_search");e.length?(e.on("drop",t.dropHandler),c(".ace_searchbtn_close").trigger("click")):setTimeout(i,50)};a.on("change",function(){o.change()}),setTimeout(i,5);var s=a.onPaste;return a.onPaste=function(e){t.restrictedEdit?a.insert(t.getClipboard()):s.call(a,e)},a.on("copy",function(e){t.setClipboard(e)}),c(n).on("paste","*",t.restrictedPaste),c(n+" div.ace_content").on("drop",t.dropHandler),c(n+" div.ace_content").on("dragover",t.dragoverHandler),this.adjustSize(),a},this.close=function(){this.setOpen(!1),null!==a&&(this.setContent(a.getValue()),a.destroy(),r=a=null)}}});