define(["jquery","mod_vpl/vplutil"],function(h,c){return function(){var e=this,o=null,a=null,r=e.getFileManager().readOnly,t=this.getContent;this.getContent=function(){return this.isOpen()?o.getValue():t.call(this)};var n=this.setContent;this.setContent=function(e){n.call(this,e),this.isOpen()&&o.setValue(e)};var i=this.destroy;this.destroy=function(){this.isOpen()&&o.destroy(),i.call(this)},this.setFontSize=function(e){this.isOpen()&&o.setFontSize(e)};var s=this.adjustSize;this.adjustSize=function(){return!!s.call(this)&&(o.resize(),!0)},this.gotoLine=function(e){this.isOpen()&&(o.gotoLine(e,0),o.scrollToLine(e,!0),o.focus())},this.setReadOnly=function(e){r=e,this.isOpen()&&o.setReadOnly(e)},this.focus=function(){var e;this.isOpen()&&(e=this.getTId(),h(e).removeClass("ui-widget-content ui-tabs-panel"),h(e).addClass("ui-corner-bottom"),this.adjustSize(),o.focus())},this.blur=function(){this.isOpen()&&o.blur()},this.undo=function(){this.isOpen()&&(o.undo(),o.focus())},this.redo=function(){this.isOpen()&&(o.redo(),o.focus())},this.selectAll=function(){this.isOpen()&&(o.selectAll(),o.focus())},this.hasUndo=function(){return!!this.isOpen()&&a.getUndoManager().hasUndo()},this.hasRedo=function(){return!!this.isOpen()&&a.getUndoManager().hasRedo()},this.hasSelectAll=c.returnTrue,this.hasFind=c.returnTrue,this.hasFindReplace=c.returnTrue,this.hasNext=c.returnTrue,this.find=function(){this.isOpen()&&o.execCommand("find")},this.replace=function(){this.isOpen()&&o.execCommand("replace")},this.next=function(){this.isOpen()&&o.execCommand("findnext")},this.getAnnotations=function(){return this.isOpen()?a.getAnnotations():[]},this.setAnnotations=function(e){return!!this.isOpen()&&a.setAnnotations(e)},this.clearAnnotations=function(){return!!this.isOpen()&&a.clearAnnotations()},this.langSelection=function(){var e,t;this.isOpen()&&(t="text",""!==(e=c.fileExtension(this.getFileName()))&&(t=c.langType(e)),a.setMode("ace/mode/"+t))},this.getEditor=function(){return!!this.isOpen()&&o},this.setTheme=function(e){this.isOpen()&&o.setTheme("ace/theme/"+e)},this.open=function(){if(this.showFileName(),"undefined"==typeof ace)return c.loadScript(["../editor/ace9/ace.js","../editor/ace9/ext-language_tools.js"],function(){e.open()}),!1;if(this.isOpen())return!1;var t=this.getFileManager(),n=this.getTId();h(n).removeClass("ui-widget-content ui-tabs-panel"),h(n).addClass("ui-corner-bottom"),ace.require("ext/language_tools"),o=ace.edit("vpl_file"+this.getId()),a=o.getSession(),o.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),o.setValue(this.getContent()),o.setFontSize(t.getFontSize()),o.setTheme("ace/theme/"+t.getTheme()),o.gotoLine(0,0),o.setReadOnly(r),a.setUseSoftTabs(!0),a.setTabSize(4),a.setUndoManager(new ace.UndoManager),this.setOpen(!0),this.langSelection(),o.execCommand("replace");var i=function(){var e=h(n+" div.ace_search");e.length?(e.on("drop",t.dropHandler),h(".ace_searchbtn_close").trigger("click")):setTimeout(i,50)};o.on("change",function(){e.change()}),setTimeout(i,5);var s=o.onPaste;return o.onPaste=function(e){t.restrictedEdit?o.insert(t.getClipboard()):s.call(o,e)},o.on("copy",function(e){t.setClipboard(e)}),h(n).on("paste","*",t.restrictedPaste),h(n+" div.ace_content").on("drop",t.dropHandler),h(n+" div.ace_content").on("dragover",t.dragoverHandler),this.adjustSize(),o},this.close=function(){this.setOpen(!1),null!==o&&(this.setContent(o.getValue()),o.destroy(),a=o=null)}}});