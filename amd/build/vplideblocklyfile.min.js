define(["jquery","mod_vpl/vplutil"],function(r,i){return function(){var a=this,l=this.getVPLIDE();this.firstFocus=!0,this.workspacePlayground=!1;this.focus=function(){a.firstFocus&&(a.workspacePlayground?(a.firstFocus=!1,Blockly.Events.disable(),a.setContent(e.call(a)),i.adjustBlockly(a.workspacePlayground,10,10),a.workspacePlayground.scrollX=0,a.workspacePlayground.scrollY=0,Blockly.svgResize(a.workspacePlayground),Blockly.resizeSvgContents(a.workspacePlayground),a.adjustSize(),Blockly.Events.enable()):i.longDelay("focus",a.focus))},this.adjustSize=function(){if(!this.isOpen()||!this.workspacePlayground)return!1;var t=r(this.getTId());if(0===t.length)return!1;var e=t.parent().height();return e-=t.position().top,t.height(e),r("#"+this.bdiv).height(e),r("#"+this.bdiv).width(t.width()),Blockly.svgResize(this.workspacePlayground),!1},this.undo=function(){this.isOpen()&&this.workspacePlayground.undo(!1)},this.redo=function(){this.isOpen()&&this.workspacePlayground.undo(!0)},this.interpreter=!1,this.animateRun=!1,this.RUNSTATE=1,this.STEPSTATE=2,this.STOPSTATE=3,this.executionState=this.STOPSTATE,this.goNext=!1,this.initRun=function(t){var s=l.getTerminal();s.isConnected()&&s.closeLocal(),this.animateRun=t,Blockly.JavaScript.STATEMENT_PREFIX="highlightBlock(%1);\n",Blockly.JavaScript.addReservedWords("highlightBlock");var e=Blockly.JavaScript.workspaceToCode(a.workspacePlayground);a.interpreter=new Interpreter(e,function(e,t){var o=function(t){return t=t?t.toString()+"\r\n":t+"\r\n",e.createPrimitive(s.writeLocal(t))};e.setProperty(t,"alert",e.createNativeFunction(o)),o=function(t,e){t=t?t.toString():""+t,s.writeLocal(t),s.setDataCallback(function(t){s.writeLocal("\n"),e(t)})},e.setProperty(t,"prompt",e.createAsyncFunction(o)),o=function(t){t==a.breakpoint&&(a.executionState=a.STEPSTATE,a.updateRunButtons(),l.getTerminal().setMessage(i.str("breakpoint"))),!a.animateRun&&a.executionState!=a.STEPSTATE||a.workspacePlayground.highlightBlock(t),a.goNext=!1},e.setProperty(t,"highlightBlock",e.createNativeFunction(o))}),s.connectLocal(a.stop,i.doNothing)},this.reservedWords={Infinity:!0,Array:!0,Boolean:!0,Date:!0,Error:!0,EvalError:!0,Function:!0,JSON:!0,Math:!0,NaN:!0,Number:!0,Object:!0,RangeError:!0,ReferenceError:!0,RegExp:!0,String:!0,SyntaxError:!0,TypeError:!0,URIError:!0,alert:!0,arguments:!0,constructor:!0,eval:!0,highlightBlock:!0,isFinite:!0,isNaN:!0,parseFloat:!0,parseInt:!0,prompt:!0,self:!0,this:!0,window:!0},this.breakpoint="",this.getVarValue=function(t){var e="";if(null===t)e="<b>null</b>";else if(null!=t){var o=typeof t;if("string"==o)e='"'+i.sanitizeText(t)+'"';else if("boolean"==o)e="<b>"+t+"</b>";else if("object"==o&&"Array"===t.class){e="[";for(var s=t.properties,r=0;r<s.length;r++)e+=a.getVarValue(s[r]),r!=s.length-1&&(e+=", ");e+="]"}else"object"==o?e="<b>"+t.toString()+"</b>":e+=""+t}return e},this.getVariables=function(t){var e,o="";for(var s in t){!0!==this.reservedWords[s]&&(null!=(e=t[s])&&"Function"!==e.class&&(o+="<b>"+s+"</b>:&nbsp;"+a.getVarValue(e)+"<br>\n"))}return o},this.getParameters=function(t){for(var e="(",o=0;o<t.length;o++)e+=""+t[o],o<t.length-1&&(e+=", ");return e+")"},this.showStack=function(t){for(var e=0,o='<table class="generaltable">',s=t.stateStack,r="<tr><td>0</td><td><b>Globals</b></td>",n=0;n<s.length;n++){var i=s[n];""<r&&("CallExpression"==i.node.type||n==s.length-1)&&(o+=r+"<td>"+a.getVariables(i.scope.properties),o+="</td></tr>"),"CallExpression"==i.node.type&&(!0!==a.reservedWords[i.node.callee.name]&&null!=i.node.callee.name?(r="<tr><td>"+ ++e+"</td>",r+="<td>"+i.node.callee.name+a.getParameters(i.arguments_)+"</td>"):r="")}o+="</table>",l.setResult({variables:o})},this.runLoop=function(){if(a.interpreter){a.goNext=!0;for(var t=0;t<3e4&&a.goNext&&a.executionState!=a.STOPSTATE;t++)if(!a.interpreter||!a.interpreter.step()){a.executionState=a.STOPSTATE,a.updateRunButtons();break}if(a.executionState==a.STOPSTATE)return a.workspacePlayground.highlightBlock(-1),l.getTerminal().closeLocal(),void l.setResult({variables:""});a.executionState==a.RUNSTATE?a.animateRun?(setTimeout(a.runLoop,1e3),a.showStack(a.interpreter)):setTimeout(a.runLoop,0):a.showStack(a.interpreter)}},this.start=function(){a.initRun(!1),a.executionState=a.RUNSTATE,a.updateRunButtons(),l.getTerminal().setMessage(i.str("start")),a.runLoop()},this.startAnimate=function(){a.initRun(!0),a.executionState=a.RUNSTATE,a.updateRunButtons(),l.getTerminal().setMessage(i.str("startanimate")),a.runLoop()},this.stop=function(){a.executionState=a.STOPSTATE,a.updateRunButtons(),l.getTerminal().setMessage(i.str("stop")),l.getTerminal().closeLocal(),a.interpreter=!1,l.setResult({variables:""})},this.pause=function(){a.executionState=a.STEPSTATE,l.getTerminal().setMessage(i.str("pause")),a.updateRunButtons()},this.resume=function(){a.executionState=a.RUNSTATE,l.getTerminal().setMessage(i.str("resume")),a.updateRunButtons(),a.runLoop()},this.step=function(){a.executionState==a.STOPSTATE&&a.initRun(!0),a.executionState=a.STEPSTATE,a.updateRunButtons(),l.getTerminal().setMessage(i.str("step")),a.runLoop()},this.hasUndo=function(){return!0},this.hasRedo=function(){return!0},this.oldSetFileName=this.setFileName,this.generatorMap={py:"Python",dart:"Dart",js:"JavaScript",lua:"Lua",php:"PHP"},this.generator="",this.setFileName=function(t){var e=this.getFileName(),o=i.fileExtension(e);a.oldSetFileName(t);var s=/\.([^.]+)\.blockly[123]?$/.exec(e),r=/(.+)\.blockly[123]?$/.exec(e);null!==s&&null!==r&&"string"==typeof this.generatorMap[s[1]]?(this.generator=this.generatorMap[s[1]],this.generatedFilename=r[1]):this.generator="",null!==r&&o!=i.fileExtension(e)&&this.setToolbox()},this.changeCode=function(t){var e,o,s,r;"ui"!=t.type||"selected"!=t.element?"ui"!=t.type||"category"!=t.element||t.newValue!=i.str("run")?t.recordUndo&&(a.change(),e=this.getFileManager(),""!=this.generator&&(o=Blockly[this.generator].workspaceToCode(a.workspacePlayground),-1==(s=e.fileNameExists(this.generatedFilename))&&(e.addFile({name:this.generatedFilename,contents:""},!1,i.doNothing,i.doNothing),s=e.fileNameExists(this.generatedFilename)),-1!=s&&((r=e.getFile(s)).setContent(o),r.change(),r.gotoLine(1),r.setReadOnly(!0)))):a.updateRunButtons():a.breakpoint=t.newValue},this.updateRunButtons=function(){switch(a.executionState){case a.RUNSTATE:r(".blocklyStartC").hide(),r(".blocklyStartAnimateC").hide(),r(".blocklyStopC").show(),r(".blocklyPauseC").show(),r(".blocklyResumeC").hide(),r(".blocklyStepC").hide();break;case a.STEPSTATE:r(".blocklyStartC").hide(),r(".blocklyStartAnimateC").hide(),r(".blocklyStopC").show(),r(".blocklyPauseC").hide(),r(".blocklyResumeC").show(),r(".blocklyStepC").show();break;case a.STOPSTATE:r(".blocklyStartC").show(),r(".blocklyStartAnimateC").show(),r(".blocklyStopC").hide(),r(".blocklyPauseC").hide(),r(".blocklyResumeC").hide(),r(".blocklyStepC").show()}},this.setToolbox=function(){var e=i.fileExtension(this.getFileName())+"Toolbox";!1!==a[e]?(this.workspacePlayground.updateToolbox(this[e]),this.workspacePlayground.registerButtonCallback("blocklyStartButton",this.start),this.workspacePlayground.registerButtonCallback("blocklyStartAnimateButton",this.startAnimate),this.workspacePlayground.registerButtonCallback("blocklyStopButton",this.stop),this.workspacePlayground.registerButtonCallback("blocklyPauseButton",this.pause),this.workspacePlayground.registerButtonCallback("blocklyResumeButton",this.resume),this.workspacePlayground.registerButtonCallback("blocklyStepButton",this.step),this.adjustSize()):r.ajax({url:"../editor/blocklytoolboxes/"+e+".xml",dataType:"text",success:function(t){a[e]=a.blocklyIn18(t),a.setToolbox()}})},this.open=function(){if(a.blocklyNotLoaded)return i.loadScript(["../editor/blockly/blockly_compressed.js","../editor/blockly/msg/js/en.js","../editor/blockly/blocks_compressed.js","../editor/blockly/python_compressed.js","../editor/blockly/javascript_compressed.js","../editor/blockly/php_compressed.js","../editor/blockly/lua_compressed.js","../editor/blockly/dart_compressed.js","../editor/acorn/acorn.js","../editor/acorn/interpreter.js"],function(){void 0===Blockly.PHP.workspaceToCodeOld&&(Blockly.PHP.workspaceToCodeOld=Blockly.PHP.workspaceToCode,Blockly.PHP.workspaceToCode=function(t){return"<?\n"+Blockly.PHP.workspaceToCodeOld(t)}),void 0===Blockly.Python.workspaceToCodeOld&&(Blockly.Python.workspaceToCodeOld=Blockly.Python.workspaceToCode,Blockly.Python.workspaceToCode=function(t){return"# -*- coding: utf-8 -*-\n"+Blockly.Python.workspaceToCodeOld(t)}),a.blocklyNotLoaded=!1,a.open()}),!1;var t=this.getFileName();this.setOpen(!0),this.setFileName(t);var e=!1;/.*[0-9]$/.test(i.fileExtension(t))&&(e=!0);var o=this.getTId();r(o).removeClass("ui-widget-content ui-tabs-panel"),r(o).addClass("ui-corner-bottom"),this.bdiv="bkdiv"+this.getId(),r(o).html('<div id="'+this.bdiv+'" style="height: 480px; width: 600px;"></div>');var s={toolbox:'<xml><category name=""><block type="math_number"></block></category></xml>',media:"../editor/blockly/media/",horizontalLayout:e,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.2,scaleSpeed:1.15}};return this.workspacePlayground=Blockly.inject(this.bdiv,s),this.workspacePlayground.addChangeListener(function(t){a.changeCode(t)}),this.setToolbox(),!1};var e=this.getContent;this.getContent=function(){if(!this.isOpen())return e.call(this);var t=Blockly.Xml.workspaceToDom(this.workspacePlayground);return Blockly.Xml.domToPrettyText(t)};var o=this.setContent;this.setContent=function(t){var e;o.call(this,t),this.isOpen()&&(this.workspacePlayground.clear(),e=Blockly.Xml.textToDom(t),Blockly.Xml.domToWorkspace(e,this.workspacePlayground))},this.close=function(){this.isOpen()&&(o.call(this,this.getContent()),this.workspacePlayground.dispose(),this.workspacePlayground=!1,this.firstFocus=!0,this.setOpen(!1))},this.blocklyNotLoaded=!0,this.blocklyToolbox=!1,this.blockly0Toolbox=!1,this.blockly1Toolbox=!1,this.blockly2Toolbox=!1,this.blockly3Toolbox=!1,this.blocklyStrs=["basic","intermediate","advanced","variables","operatorsvalues","control","inputoutput","functions","lists","math","text","run","start","startanimate","stop","pause","resume","step"],this.blocklyIn18=function(t){for(var e=this.blocklyStrs.length,o=0;o<e;o++){var s=this.blocklyStrs[o],r=new RegExp("\\[\\["+s+"\\]\\]","g"),n=i.str(s);t=t.replace(r,n)}return t}}});