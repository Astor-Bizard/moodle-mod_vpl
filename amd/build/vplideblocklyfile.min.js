define(["jquery","mod_vpl/vplutil"],function(a,l){return function(){var i=this,r=this.getVPLIDE();this.firstContent=!0,this.workspaceInstance=!1;var e,t;this.adjustSize=function(){if(!this.isOpen()||!this.workspaceInstance)return!1;var e=a(this.getTId());if(0===e.length)return!1;var t=e.parent().height();return t-=e.position().top,e.height(t),a("#"+this.bdiv).height(t),a("#"+this.bdiv).width(e.width()),Blockly.svgResize(this.workspaceInstance),!1},this.undo=function(){this.isOpen()&&this.workspaceInstance.undo(!1)},this.redo=function(){this.isOpen()&&this.workspaceInstance.undo(!0)},this.interpreter=!1,this.animateRun=!1,this.RUNSTATE=1,this.STEPSTATE=2,this.STOPSTATE=3,this.executionState=this.STOPSTATE,this.goNext=!1,this.initRun=function(e){var o=r.getTerminal();o.isConnected()&&o.closeLocal(),this.animateRun=e,Blockly.JavaScript.STATEMENT_PREFIX="highlightBlock(%1);\n",Blockly.JavaScript.addReservedWords("highlightBlock");var t=Blockly.JavaScript.workspaceToCode(i.workspaceInstance);i.interpreter=new Interpreter(t,function(t,e){t.setProperty(e,"alert",t.createNativeFunction(function(e){return e="string"!=typeof e?e.toString()+"\r\n":e+"\r\n",t.createPrimitive(o.writeLocal(e))}));t.setProperty(e,"prompt",t.createAsyncFunction(function(e,t){e="string"!=typeof e?e.toString():""+e,o.writeLocal(e),o.setDataCallback(function(e){o.writeLocal("\n"),t(e)})}));t.setProperty(e,"highlightBlock",t.createNativeFunction(function(e){e==i.getBreakpoint()&&(i.executionState=i.STEPSTATE,i.updateRunButtons(),r.getTerminal().setMessage(l.str("breakpoint"))),!i.animateRun&&i.executionState!=i.STEPSTATE||i.workspaceInstance.highlightBlock(e),i.goNext=!1}))}),o.connectLocal(i.stop,l.doNothing)},this.reservedWords={Infinity:!0,Array:!0,Boolean:!0,Date:!0,Error:!0,EvalError:!0,Function:!0,JSON:!0,Math:!0,NaN:!0,Number:!0,Object:!0,RangeError:!0,ReferenceError:!0,RegExp:!0,String:!0,SyntaxError:!0,TypeError:!0,URIError:!0,alert:!0,arguments:!0,constructor:!0,eval:!0,highlightBlock:!0,isFinite:!0,isNaN:!0,parseFloat:!0,parseInt:!0,prompt:!0,self:!0,this:!0,window:!0},t=e=null,i.getBreakpoint=function(){return e},i.setBreakpoint=function(){e=t},i.removeBreakpoint=function(){e=null},i.setLastSelection=function(e){t=e},i.isSelectingBreakpoint=function(){return null===e&&null!==t},this.getVarValue=function(e){var t="";if(null===e)t="<b>null</b>";else if(null!=e){var o=typeof e;if("string"==o)t='"'+l.sanitizeText(e)+'"';else if("boolean"==o)t="<b>"+e+"</b>";else if("object"==o&&"Array"===e.class){t="[";for(var n=e.properties,s=0;s<n.length;s++)t+=i.getVarValue(n[s]),s!=n.length-1&&(t+=", ");t+="]"}else"object"==o?t="<b>"+e.toString()+"</b>":t+=""+e}return t},this.getVariables=function(e){var t,o="";for(var n in e){!0!==this.reservedWords[n]&&(null!=(t=e[n])&&"Function"!==t.class&&(o+="<b>"+n+"</b>:&nbsp;"+l.sanitizeText(i.getVarValue(t))+"<br>\n"))}return o},this.getParameters=function(e){for(var t="(",o=0;o<e.length;o++)t+=""+e[o],o<e.length-1&&(t+=", ");return t+")"},this.showStack=function(e){for(var t=0,o='<table class="generaltable">',n=e.stateStack,s="<tr><td>0</td><td><b>Globals</b></td>",a=0;a<n.length;a++){var l=n[a];""<s&&("CallExpression"==l.node.type||a==n.length-1)&&(o+=s+"<td>"+i.getVariables(l.scope.properties),o+="</td></tr>"),"CallExpression"==l.node.type&&(!0!==i.reservedWords[l.node.callee.name]&&null!=l.node.callee.name?(s="<tr><td>"+ ++t+"</td>",s+="<td>"+l.node.callee.name+i.getParameters(l.arguments_)+"</td>"):s="")}o+="</table>",r.setResult({variables:o})},this.runLoop=function(){if(i.interpreter){i.goNext=!0;for(var e=0;e<3e4&&i.goNext&&i.executionState!=i.STOPSTATE;e++)if(!i.interpreter||!i.interpreter.step()){i.executionState=i.STOPSTATE,i.updateRunButtons();break}if(i.executionState==i.STOPSTATE)return i.workspaceInstance.highlightBlock(-1),r.getTerminal().closeLocal(),void r.setResult({variables:""});i.executionState==i.RUNSTATE?i.animateRun?(setTimeout(i.runLoop,1e3),i.showStack(i.interpreter)):setTimeout(i.runLoop,0):i.showStack(i.interpreter)}},this.start=function(){i.executionState==i.STOPSTATE&&(i.initRun(!1),i.executionState=i.RUNSTATE,i.updateRunButtons(),r.getTerminal().setMessage(l.str("start")),i.runLoop())},this.startAnimate=function(){i.executionState==i.STOPSTATE&&(i.initRun(!0),i.executionState=i.RUNSTATE,i.updateRunButtons(),r.getTerminal().setMessage(l.str("startanimate")),i.runLoop())},this.stop=function(){i.executionState=i.STOPSTATE,i.workspaceInstance.highlightBlock(-1),i.updateRunButtons(),r.getTerminal().setMessage(l.str("stop")),r.getTerminal().closeLocal(),i.interpreter=!1,r.setResult({variables:""})},this.pause=function(){i.executionState==i.RUNSTATE&&(i.executionState=i.STEPSTATE,r.getTerminal().setMessage(l.str("pause")),i.updateRunButtons())},this.resume=function(){i.executionState==i.STEPSTATE&&(i.executionState=i.RUNSTATE,r.getTerminal().setMessage(l.str("resume")),i.updateRunButtons(),i.runLoop())},this.step=function(){i.executionState==i.STOPSTATE&&i.initRun(!0),i.executionState=i.STEPSTATE,i.updateRunButtons(),r.getTerminal().setMessage(l.str("step")),i.runLoop()},this.hasUndo=function(){return!0},this.hasRedo=function(){return!0},this.oldSetFileName=this.setFileName,this.generatorMap={py:"Python",dart:"Dart",js:"JavaScript",lua:"Lua",php:"PHP"},this.generator="",this.setFileName=function(e){var t=this.getFileName(),o=l.fileExtension(t);if(!i.oldSetFileName(e))return l.log("Blockly setFileName: name no acepted "+e),!1;l.log("Blockly set filename "+e);var n=/\.([^.]+)\.blockly[123]?$/.exec(e),s=/(.+)\.blockly[123]?$/.exec(e);return null!==n&&null!==s&&"string"==typeof this.generatorMap[n[1]]?(this.generator=this.generatorMap[n[1]],this.generatedFilename=s[1],l.log("Blockly generator "+this.generator+" for filename "+this.generatedFilename),this.updateGeneratedCode()):this.generator="",o!=l.fileExtension(e)&&(l.log("Blockly extension changed"),l.afterAll("reopenBlockly",function(){l.log("reopenBlockly"),i.close(),i.open()})),!0},this.updateGeneratedCode=function(){var e,t,o,n;i.blocklyNotLoaded||(e=i.getFileManager(),""!=i.generator&&(l.log("Blockly generate "+i.generator),t=Blockly[i.generator].workspaceToCode(i.workspaceInstance),-1==(o=e.fileNameExists(i.generatedFilename))&&(l.log("try to create "+i.generatedFilename+" files"),e.addFile({name:i.generatedFilename,contents:""},!1,l.doNothing,l.doNothing),o=e.fileNameExists(i.generatedFilename)),-1==o||(n=e.getFile(o)).getContent()!=t&&(n.setContent(t),n.change(),n.gotoLine(1),n.setReadOnly(!0))))},this.changeCode=function(e){if(l.log(e),"ui"!=e.type||"selected"!=e.element)if("ui"!=e.type||"category"!=e.element||e.newValue!=l.str("run")){if(i.firstContent){if("finished_loading"!=e.type)return;i.firstContent=!1,i.workspaceInstance.clearUndo()}e.recordUndo&&(l.log("Call change due changeCode"),i.change(),""!=i.generator&&l.afterAll("generate"+i.getFileName(),i.updateGeneratedCode))}else l.longDelay("updateRunButtons",i.updateRunButtons);else i.setLastSelection(e.newValue)};var o=0;this.updateRunButtons=function(){if(0==a(".blocklySelectBreakpointC").length)return 20<++o?(o=0,void l.log("Giving up to tries of updateRunButtons")):void l.longDelay("updateRunButtons",i.updateRunButtons);l.log("updateRunButtons"),o=0;var e="vpl_dimmed";switch(i.isSelectingBreakpoint()?a(".blocklySelectBreakpointC").removeClass(e):a(".blocklySelectBreakpointC").addClass(e),null===i.getBreakpoint()?a(".blocklyRemoveBreakpointC").addClass(e):a(".blocklyRemoveBreakpointC").removeClass(e),i.executionState){case i.RUNSTATE:a(".blocklyStartC").addClass(e),a(".blocklyStartAnimateC").addClass(e),a(".blocklyStopC").removeClass(e),a(".blocklyPauseC").removeClass(e),a(".blocklyResumeC").addClass(e),a(".blocklyStepC").addClass(e);break;case i.STEPSTATE:a(".blocklyStartC").addClass(e),a(".blocklyStartAnimateC").addClass(e),a(".blocklyStopC").removeClass(e),a(".blocklyPauseC").addClass(e),a(".blocklyResumeC").removeClass(e),a(".blocklyStepC").removeClass(e);break;case i.STOPSTATE:a(".blocklyStartC").removeClass(e),a(".blocklyStartAnimateC").removeClass(e),a(".blocklyStopC").addClass(e),a(".blocklyPauseC").addClass(e),a(".blocklyResumeC").addClass(e),a(".blocklyStepC").removeClass(e)}},this.setToolbox=function(){var t=l.fileExtension(this.getFileName())+"Toolbox";if(!1!==i[t]){var e={blocklyStartButton:this.start,blocklyStartAnimateButton:this.startAnimate,blocklyStopButton:this.stop,blocklyPauseButton:this.pause,blocklyResumeButton:this.resume,blocklyStepButton:this.step,blocklySelectBreakpointButton:this.setBreakpoint,blocklyRemoveBreakpointButton:this.removeBreakpoint},o=this.workspaceInstance;for(var n in o.updateToolbox(this[t]),e)o.registerButtonCallback(n,function(e){return function(){e(),i.updateRunButtons()}}(e[n]));this.adjustSize()}else a.ajax({url:"../editor/blocklytoolboxes/"+t+".xml",dataType:"text",success:function(e){i[t]=i.blocklyIn18(e),i.setToolbox()}})},this.open=function(){if(this.showFileName(),i.blocklyNotLoaded)return l.loadScript(["../editor/blockly/blockly_compressed.js","../editor/blockly/msg/js/en.js","../editor/blockly/blocks_compressed.js","../editor/blockly/python_compressed.js","../editor/blockly/javascript_compressed.js","../editor/blockly/php_compressed.js","../editor/blockly/lua_compressed.js","../editor/blockly/dart_compressed.js","../editor/acorn/acorn.js","../editor/acorn/interpreter.js"],function(){l.log("Blocklyloaded",!0),void 0===Blockly.PHP.workspaceToCodeOld&&(Blockly.PHP.workspaceToCodeOld=Blockly.PHP.workspaceToCode,Blockly.PHP.workspaceToCode=function(e){return"<?php\n"+Blockly.PHP.workspaceToCodeOld(e)}),void 0===Blockly.Python.workspaceToCodeOld&&(Blockly.Python.workspaceToCodeOld=Blockly.Python.workspaceToCode,Blockly.Python.workspaceToCode=function(e){return"# -*- coding: utf-8 -*-\n"+Blockly.Python.workspaceToCodeOld(e)}),i.blocklyNotLoaded=!1,i.open()}),!1;var e=this.getContent();this.setOpen(!0);var t=this.getFileName(),o=!1;/.*[0-9]$/.test(l.fileExtension(t))&&(o=!0);var n=this.getTId();a(n).removeClass("ui-widget-content ui-tabs-panel"),a(n).addClass("ui-corner-bottom"),this.bdiv="bkdiv"+this.getId(),a(n).html('<div id="'+this.bdiv+'" style="height: 480px; width: 600px;"></div>');var s={toolbox:'<xml><category name="" colour="330"><block type="math_number"></block></category></xml>',media:"../editor/blockly/media/",horizontalLayout:o,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.2,scaleSpeed:.3}};return this.workspaceInstance=Blockly.inject(this.bdiv,s),this.setToolbox(),this.firstContent=!0,i.workspaceInstance.addChangeListener(i.changeCode),this.setContent(e),l.adjustBlockly(i.workspaceInstance,10,10),i.workspaceInstance.scrollX=0,i.workspaceInstance.scrollY=0,Blockly.svgResize(i.workspaceInstance),Blockly.resizeSvgContents(i.workspaceInstance),i.adjustSize(),!1};var n=this.getContent;this.getContent=function(){if(!this.isOpen())return n.call(this);var e=Blockly.Xml.workspaceToDom(this.workspaceInstance);return Blockly.Xml.domToPrettyText(e)};var s=this.setContent;this.setContent=function(e){var t;s.call(this,e),this.isOpen()&&(this.workspaceInstance.clear(),t=Blockly.Xml.textToDom(e),Blockly.Xml.domToWorkspace(t,this.workspaceInstance))},this.close=function(){this.isOpen()&&(s.call(this,this.getContent()),this.workspaceInstance.dispose(),this.workspaceInstance=!1,this.setOpen(!1))},this.blocklyNotLoaded=!0,this.blocklyToolbox=!1,this.blockly0Toolbox=!1,this.blockly1Toolbox=!1,this.blockly2Toolbox=!1,this.blockly3Toolbox=!1,this.blocklyStrs=["basic","intermediate","advanced","variables","operatorsvalues","control","inputoutput","functions","lists","math","text","run","start","startanimate","stop","pause","resume","step","breakpoint","selectbreakpoint","removebreakpoint"],this.blocklyIn18=function(e){for(var t=this.blocklyStrs.length,o=0;o<t;o++){var n=this.blocklyStrs[o],s=new RegExp("\\[\\["+n+"\\]\\]","g"),a=l.str(n);e=e.replace(s,a)}return e}}});