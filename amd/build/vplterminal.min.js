define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard"],function(a,b,c,d){if("undefined"!=typeof f)return f;var e=5,f=function(b,f,g){function h(a){if(y+=a,y.length>x){var b=y.length-x/2;y=y.substr(b)}}function i(){p&&p.readyState==p.OPEN&&p.send(w.getEntry2())}function j(){w.setEntry1(y)}function k(){j(),w.show()}function l(a){var b="vpl_terminal_theme",d=5;t.data("terminal_theme",a),c.setUserPreferences({terminalTheme:a});for(var e=0;e<d;e++)t.removeClass(b+e);t.addClass(b+a)}function m(){var a=u.offset(),b=t.parent().offset();b.top=b.top<a.top?a.top:b.top,b.left=b.left<a.left?a.left:b.left,t.parent().offset(b);var c=u.width(),d=u.height();t.width()>c&&t.dialog("option","width",c),t.parent().height()>d&&t.dialog("option","height",d-t.prev().outerHeight())}var n,o=this,p=null,q=function(){},r="",s="",t=a("#"+b),u=a("#vplide"),v="",w=null,x=64e3,y="",z=a("#"+f);this.updateTitle=function(){var a=r;""!==s&&(a+=" ("+s+")"),v.text(g("console")+": "+a)},this.setTitle=function(a){r=a,this.updateTitle()},this.setMessage=function(a){s=a,this.updateTitle()},this.write=function(a){return n.write(a),a},this.connect=function(a,b){q=b,"WebSocket"in window?(n.reset(),n.startBlink(),o.show(),p&&p.close(),y="",o.setMessage(""),o.setTitle(g("connecting")),p=new WebSocket(a),p.writeBuffer="",p.writeIt=function(){n.write(p.writeBuffer),h(p.writeBuffer),p.writeBuffer=""},p.onmessage=function(a){p.writeBuffer.length>0?p.writeBuffer+=a.data:(p.writeBuffer=a.data,setTimeout(p.writeIt,35))},p.onopen=function(){o.setMessage(""),o.setTitle(g("connected"))},p.onclose=function(){o.setTitle(g("connection_closed")),n.blur(),n.stopBlink(),b(),p.stopOutput=!0}):n.write("WebSocket not available: Upgrade your browser")},this.writeLocal=function(a){return p.onmessage({data:a}),a},this.setDataCallback=function(a){p.onData=a},this.closeLocal=function(){p&&(p.writeIt(),p.close(),n.stopBlink(),o.setTitle(g("connection_closed")))},this.connectLocal=function(a,b){q=a,n.reset(),n.startBlink(),o.show(),p&&p.close(),y="",o.setMessage(""),o.setTitle(g("running")),p={},p.onData=b,p.writeBuffer="",p.readBuffer="",p.readyState=1,p.OPEN=1,p.close=function(){p=!1},p.onmessage=function(a){p.writeBuffer=a.data,p.writeIt()},p.writeIt=function(){p&&(n.write(p.writeBuffer),h(p.writeBuffer),p.writeBuffer="")},p.send=function(a){""==a?p.readBuffer.length>0&&(o.writeLocal("\b \b"),p.readBuffer=p.readBuffer.substr(0,p.readBuffer.length-1)):(o.writeLocal(a),p.readBuffer+=a);var b=p.readBuffer.indexOf("\r");if(b!=-1){var c=p.readBuffer.substr(0,b);p.readBuffer=p.readBuffer.substr(b+1),p.onData(c)}}},this.isOpen=function(){return t.dialog("isOpen")},this.close=function(){t.dialog("close")},this.isConnected=function(){return p&&p.readyState!=p.CLOSED},this.disconnect=function(){p&&p.readyState==p.OPEN&&(q(),p&&p.close(),n.stopBlink())};var A=c.genIcon("copy","sw")+" "+g("copy"),B=c.genIcon("paste","sw")+" "+g("paste");w=new d("vpl_dialog_terminal_clipboard",A,function(){j(),document.execCommand("copy")},B,i),this.closeDialog=function(){w.hide(),o.disconnect()},t.dialog({closeOnEscape:!1,autoOpen:!1,width:"auto",height:"auto",resizable:!0,dragStop:m,open:m,focus:function(){m(),n.focus()},dialogClass:"vpl_ide vpl_vnc",create:function(){v=c.setTitleBar(t,"console","console",["clipboard","keyboard","theme"],[k,function(){n.focus()},function(){var a=(t.data("terminal_theme")+1)%e;l(a)}])},close:function(){o.closeDialog()},resizeStop:function(){t.width(t.parent().width()),t.height(t.parent().height()-t.prev().outerHeight()),m(),n.focus()}}),this.setFontSize=function(a){z.css("font-size",a+"px")},c.getUserPreferences(function(a){l(a.preferences.terminalTheme)}),t.css("padding","1px"),this.show=function(){t.dialog("open"),n.focus()},this.init=function(){return"undefined"==typeof Terminal?void c.loadScript(["../../vpl/editor/xterm/term.js"],function(){o.init()}):(n=new Terminal({cols:80,rows:24,useStyle:!0,screenKeys:!0}),n.on("data",function(a){p&&p.readyState==p.OPEN&&p.send(a)}),n.open(z[0]),n.reset(),n.stopBlink(),void n.setLineCallback(function(a,b){var c=z.height(),d=t.scrollTop(),e=t.innerHeight();if(!(e>=c)){var f=c/b,g=a*f;g>=d&&g<e+d-f||(g<d?t.scrollTop(g):t.scrollTop(g-e+2*f))}}))},this.init()};return window.VPLTerminal=f,f});