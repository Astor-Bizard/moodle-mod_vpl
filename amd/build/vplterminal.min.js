define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard"],function(S,e,_,k){if(void 0!==t)return t;var t=function(e,t,n){var i,o=this,r=null,s=_.doNothing,a="",c="",u=S("#"+e),f=S("#vplide"),l="",d=null,h=64e3,p="",w=S("#"+t);function g(e){var t;(p+=e).length>h&&(t=p.length-h/2,p=p.substr(t))}function B(){d.setEntry1(p)}function m(){B(),d.show()}this.updateTitle=function(){var e=a;""!==c&&(e+=" ("+c+")"),l.text(n("console")+": "+e)},this.setTitle=function(e){a=e,this.updateTitle()},this.setMessage=function(e){c=e,this.updateTitle()},this.write=function(e){return i.write(e),e},this.connect=function(e,t){s=t,"WebSocket"in window?(i.reset(),i.startBlink(),o.show(),r&&r.close(),p="",o.setMessage(""),o.setTitle(n("connecting")),(r=new WebSocket(e)).writeBuffer="",r.writeIt=function(){i.write(r.writeBuffer),g(r.writeBuffer),r.writeBuffer=""},r.onmessage=function(e){0<r.writeBuffer.length?r.writeBuffer+=e.data:(r.writeBuffer=e.data,setTimeout(r.writeIt,35))},r.onopen=function(){o.setMessage(""),o.setTitle(n("connected"))},r.onclose=function(){o.setTitle(n("connection_closed")),i.blur(),i.stopBlink(),t(),r.stopOutput=!0}):i.write("WebSocket not available: Upgrade your browser")},this.writeLocal=function(e){return r.onmessage({data:e}),e},this.setDataCallback=function(e){r.onData=e},this.closeLocal=function(){r&&(r.writeIt(),r.close(),i.stopBlink(),o.setTitle(n("connection_closed")))},this.connectLocal=function(e,t){s=e,i.reset(),i.startBlink(),o.show(),r&&r.close(),p="",o.setMessage(""),o.setTitle(n("running")),(r={}).onData=t,r.writeBuffer="",r.readBuffer="",r.readyState=1,r.OPEN=1,r.close=function(){r=!1},r.onmessage=function(e){r.writeBuffer=e.data,r.writeIt()},r.writeIt=function(){r&&(i.write(r.writeBuffer),g(r.writeBuffer),r.writeBuffer="")},r.send=function(e){""==e?0<r.readBuffer.length&&(o.writeLocal("\b \b"),r.readBuffer=r.readBuffer.substr(0,r.readBuffer.length-1)):(o.writeLocal(e),r.readBuffer+=e);var t,n=r.readBuffer.indexOf("\r");-1!=n&&(t=r.readBuffer.substr(0,n),r.readBuffer=r.readBuffer.substr(n+1),r.onData(t))}},this.isOpen=function(){return u.dialog("isOpen")},this.close=function(){u.dialog("close")},this.isConnected=function(){return r&&r.readyState!=r.CLOSED},this.disconnect=function(){r&&r.readyState==r.OPEN&&(s(),r&&r.close(),i.stopBlink())};var v=_.genIcon("copy","sw")+" "+n("copy"),b=_.genIcon("paste","sw")+" "+n("paste");function T(e){var t="vpl_terminal_theme";u.data("terminal_theme",e),_.setUserPreferences({terminalTheme:e});for(var n=0;n<5;n++)u.removeClass(t+n);u.addClass(t+e)}function y(){var e=f.width(),t=f.height();u.width()>e&&u.dialog("option","width",e),u.parent().height()>t&&u.dialog("option","height",t-u.prev().outerHeight())}d=new k("vpl_dialog_terminal_clipboard",v,function(){B(),document.execCommand("copy")},b,function(){r&&r.readyState==r.OPEN&&r.send(d.getEntry2())}),this.closeDialog=function(){d.hide(),o.disconnect()},u.dialog({closeOnEscape:!1,autoOpen:!1,width:"auto",height:"auto",resizable:!0,dragStop:y,open:y,focus:function(){y(),i.focus()},dialogClass:"vpl_ide vpl_vnc",create:function(){l=_.setTitleBar(u,"console","console",["clipboard","keyboard","theme"],[m,function(){i.focus()},function(){T((u.data("terminal_theme")+1)%5)}])},close:function(){o.closeDialog()},resizeStop:function(){u.width(u.parent().width()),u.height(u.parent().height()-u.prev().outerHeight()),y(),i.focus()}}),this.setFontSize=function(e){w.css("font-size",e+"px")},_.getUserPreferences(function(e){T(e.preferences.terminalTheme)}),u.css("padding","1px"),this.show=function(){u.dialog("open"),i.focus()},this.init=function(){"undefined"!=typeof Terminal?((i=new Terminal({cols:80,rows:24,useStyle:!0,screenKeys:!0})).on("data",function(e){r&&r.readyState==r.OPEN&&r.send(e)}),i.open(w[0]),i.reset(),i.stopBlink(),i.setLineCallback(function(e,t){var n,i,o=w.height(),r=u.scrollTop(),s=u.innerHeight();o<=s||(r<=(i=e*(n=o/t))&&i<s+r-n||(i<r?u.scrollTop(i):u.scrollTop(i-s+2*n)))})):_.loadScript(["../../vpl/editor/xterm/term.js"],function(){o.init()})},this.init()};return window.VPLTerminal=t});