define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard"],function(a,b,c,d){if("undefined"!=typeof e)return e;var e=function(b,e,f){function g(a){if(u+=a,u.length>t){var b=u.length-t/2;u=u.substr(b)}}function h(){m&&m.readyState==m.OPEN&&m.send(s.getEntry2())}function i(){s.setEntry1(u)}function j(){i(),s.show()}var k,l=this,m=null,n=function(){},o="",p="",q=a("#"+b),r="",s=null,t=64e3,u="",v=a("#"+e);this.updateTitle=function(){var a=o;""!==p&&(a+=" ("+p+")"),r.text(f("console")+": "+a)},this.setTitle=function(a){o=a,this.updateTitle()},this.setMessage=function(a){p=a,this.updateTitle()},this.write=function(a){return k.write(a),a},this.connect=function(a,b){n=b,"WebSocket"in window?(k.reset(),k.startBlink(),l.show(),m&&m.close(),u="",l.setMessage(""),l.setTitle(f("connecting")),m=new WebSocket(a),m.writeBuffer="",m.writeIt=function(){k.write(m.writeBuffer),g(m.writeBuffer),m.writeBuffer=""},m.onmessage=function(a){m.writeBuffer.length>0?m.writeBuffer+=a.data:(m.writeBuffer=a.data,setTimeout(m.writeIt,0))},m.onopen=function(){l.setMessage(""),l.setTitle(f("connected"))},m.onclose=function(){l.setTitle(f("connection_closed")),k.blur(),k.stopBlink(),b(),m.stopOutput=!0}):k.write("WebSocket not available: Upgrade your browser")},this.writeLocal=function(a){return m.onmessage({data:a}),a},this.setDataCallback=function(a){m.onData=a},this.closeLocal=function(){m&&(m.writeIt(),m.close(),k.stopBlink(),l.setTitle(f("connection_closed")))},this.connectLocal=function(a,b){n=a,k.reset(),k.startBlink(),l.show(),m&&m.close(),u="",l.setMessage(""),l.setTitle(f("running")),m={},m.onData=b,m.writeBuffer="",m.readBuffer="",m.readyState=1,m.OPEN=1,m.close=function(){m=!1},m.onmessage=function(a){m.writeBuffer=a.data,m.writeIt()},m.writeIt=function(){m&&(k.write(m.writeBuffer),g(m.writeBuffer),m.writeBuffer="")},m.send=function(a){""==a?m.readBuffer.length>0&&(l.writeLocal("\b \b"),m.readBuffer=m.readBuffer.substr(0,m.readBuffer.length-1)):(l.writeLocal(a),m.readBuffer+=a);var b=m.readBuffer.indexOf("\r");if(b!=-1){var c=m.readBuffer.substr(0,b);m.readBuffer=m.readBuffer.substr(b+1),m.onData(c)}}},this.isOpen=function(){return q.dialog("isOpen")===!0},this.isConnected=function(){return m&&m.readyState!=m.CLOSED},this.disconnect=function(){m&&m.readyState==m.OPEN&&(n(),m&&m.close(),k.stopBlink())};var w=c.gen_icon("copy","sw")+" "+f("copy"),x=c.gen_icon("paste","sw")+" "+f("paste");s=new d("vpl_dialog_terminal_clipboard",w,function(){i(),document.execCommand("copy")},x,h),this.closeDialog=function(){s.hide(),l.disconnect()},q.dialog({closeOnEscape:!1,autoOpen:!1,width:"auto",height:"auto",resizable:!0,focus:function(){k.focus()},dialogClass:"vpl_ide vpl_vnc",create:function(){r=c.setTitleBar(q,"console","console",["clipboard","keyboard"],[j,function(){k.focus()}])},close:function(){l.closeDialog()},resizeStart:function(){var a=q.find("pre").width(),b=q.find("pre div").width();a<=b&&q.find("pre").width(b)}}),q.css("padding","1px"),this.show=function(){q.dialog("open"),k.focus()},this.init=function(){return"undefined"==typeof Terminal?void c.loadScript(["../../vpl/editor/xterm/term.js"],function(){l.init()}):(k=new Terminal({cols:80,rows:24,useStyle:!0,screenKeys:!0}),k.on("data",function(a){m&&m.readyState==m.OPEN&&m.send(a)}),k.open(v[0]),k.reset(),void k.stopBlink())},this.init()};return window.VPL_Terminal=e,e});