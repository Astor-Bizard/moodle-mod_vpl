define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplidefile","mod_vpl/vplidebutton","mod_vpl/vplterminal","mod_vpl/vplvnc"],function(we,e,Fe,ye,Te,xe,Le){if(void 0!==i)return i;var Me,i=function(e,p){var h,u,v,a,f,g=this,m=p.minfiles||0,_=p.maxfiles||0,b=p.restrictededitor||p.example,w=p.example,r=!1,F=Fe.scrollBarWidth(),y=Fe.str,t=we("#"+e);if(we("head").append('<meta name="viewport" content="initial-scale=1">').append('<meta name="viewport" width="device-width">').append('<link rel="stylesheet" href="../editor/VPLIDE.css"/>'),"object"!=typeof t)throw new Error("VPL: constructor tag_id not found");var i,n={new:!0,rename:!0,delete:!0,save:!0,run:!0,edit:!0,debug:!0,evaluate:!0,import:!0,resetfiles:!0,sort:!0,multidelete:!0,acetheme:!0,console:!0,comments:!0};function s(e){return!n[e]||p[e]}function T(e){e.originalEvent.dataTransfer.dropEffect=b?"none":"copy",e.preventDefault()}function x(e){if(b)return e.stopImmediatePropagation(),!1;var t=e.originalEvent.dataTransfer;return!(0<t.files.length)||(Fe.readSelectedFiles(t.files,function(e){return h.addFile(e,!0,f,a)},function(){h.fileListVisibleIfNeeded()}),e.stopImmediatePropagation(),!1)}function L(e){return!b||(e.stopPropagation(),!1)}void 0===p.loadajaxurl&&(p.loadajaxurl=p.ajaxurl),i=m<_,p.new=i,p.rename=i,p.delete=i,p.comments=p.comments&&!p.example,p.acetheme=!0,p.sort=2<=_-m,p.multidelete=p.sort,p.import=!b,p.console=s("run")||s("debug"),void 0===p.fontSize&&(p.fontSize=12),p.fontSize=parseInt(p.fontSize),t.on("drop",x),t.on("dragover",T);var d=we("#vpl_menu"),M=new Te(d,s),c=we("#vpl_tr"),A=we("#vpl_filelist"),z=we("#vpl_filelist_header"),k=we("#vpl_filelist_content"),C=we("#vpl_tabs_ul"),S=we("#vpl_tabs"),V=we("#vpl_results"),H=we("#vpl_results_accordion");A.vplMinWidth=80,V.vplMinWidth=100,this.updateEvaluationNumber=function(e){var t;void 0!==e.nevaluations&&(t=e.nevaluations,void 0!==e.reductionbyevaluation&&""<e.reductionbyevaluation&&0!=e.reductionbyevaluation&&(0!=e.freeevaluations&&(t=t+"/"+e.freeevaluations),t=t+" -"+e.reductionbyevaluation),M.setExtracontent("evaluate",t))},this.lastResult=null,this.getTerminal=function(){return le},this.setResultGrade=function(e,t){var i="vpl_ide_accordion_t_grade",n="vpl_ide_accordion_c_grade";if(0==H.find("."+n).length&&(H.append('<div class="'+i+'"></div>'),H.append('<div class="'+n+'"></div>')),void 0===t)return 0<H.find("h4."+i).length;var l=H.find("."+i);return""<e?(l.replaceWith('<h4 class="'+i+'">'+e+"</h4>"),!0):(l.replaceWith('<div class="'+i+'"></div>'),!1)},this.setResultTab=function(e,t,i){var n="vpl_ide_accordion_t_"+e,l="vpl_ide_accordion_c_"+e;if(0==H.find("."+l).length&&(H.append('<div class="'+n+'"></div>'),H.append('<div class="'+l+'"></div>')),void 0===i)return 0<H.find("h4."+n).length;var o=H.find("."+n),a=H.find("."+l),s=we("<div>"+t+"</div>");return s.find("h4").replaceWith(function(){return we("<h5>").append(we(this).contents())}),a.html()==s.html()?""<t:""<t?(o.replaceWith('<h4 class="'+n+'">'+y(e)+"</h4>"),a.replaceWith('<div class="ui-widget '+l+'">'+s.html()+"</div>"),!0):(o.replaceWith('<div class="'+n+'"></div>'),a.replaceWith('<div class="'+l+'"></div>'),!1)},this.setResult=function(e,t){g.updateEvaluationNumber(e);for(var i=h.getFiles(),n=[],l=0;l<i.length;l++)n[l]=i[l].getFileName(),i[l].clearAnnotations();var o,a,s=Fe.sanitizeText(e.grade),r=g.setResultGrade(s,e.grade),d=r,c=g.setResultTab("variables",e.variables,e.variables);if(d=d||c,o=Fe.processResult(e.compilation,n,i,!0,!1),c=g.setResultTab("compilation",o,e.compilation),d=d||c,o=Fe.processResult(e.evaluation,n,i,!1,!1),c=g.setResultTab("comments",o,e.evaluation),d=d||c,o=Fe.sanitizeText(e.execution),c=g.setResultTab("execution",o,e.execution),d=d||c,(c=g.setResultTab("description",p.description,p.description))&&"object"==typeof MathJax&&(a=H.find(".vpl_ide_accordion_c_description")[0],MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])),d||c){for(V.show(),V.vplVisible=!0,H.accordion("refresh"),H.accordion("option","active",r?1:0),l=0;l<i.length;l++)for(var u=i[l].getAnnotations(),f=0;f<u.length;f++)if(t||"error"==u[f].type){h.gotoFile(l,u[f].row+1);break}}else V.hide(),V.vplVisible=!1;Fe.delay("autoResizeTab",v)},H.accordion({heightStyle:"fill",header:"h4",animate:!1,beforeActivate:function(e,t){return!("newHeader"in t&&t.newHeader.hasClass("vpl_ide_accordion_t_grade"))}}),V.width(2*V.vplMinWidth),H.on("click","a",function(e){e.preventDefault(),h.gotoFileLink(e.currentTarget)}),V.vplVisible=!1,V.hide(),A.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),z.text(y("filelist")),z.html(Fe.iconFolder()+z.html()),z.addClass("ui-widget-header ui-button-text-only ui-corner-all"),k.addClass("ui-widget ui-corner-all"),A.width(2*A.vplMinWidth),A.on("click","a",function(e){e.preventDefault(),h.gotoFileLink(e.currentTarget)}),A.vplVisible=!1,A.hide(),S.tabs({classes:{"ui-tabs-panel":null}});var N=!1;function I(){return!1===N&&(N=(S.outerWidth(!0)-S.width())/2),N}function l(e,t){var i,n,l=t.position.left-t.originalPosition.left;0!=l?(i=S.width()+A.width()-A.vplMinWidth,S.resizable("option","maxWidth",i),A.width(A.vplOriginalWidth+l)):(i=S.width()+V.width()-V.vplMinWidth,S.resizable("option","maxWidth",i),n=t.size.width-t.originalSize.width,V.width(V.vplOriginalWidth-n)),h.currentFile("adjustSize")}var W={containment:"parent",resize:l,start:function(){we(window).off("resize",v),S.resizable("option","minWidth",100),V.vplVisible&&(V.vplOriginalWidth=V.width()),A.vplVisible&&(A.vplOriginalWidth=A.width())},stop:function(e,t){l(0,t),S.resizable("option","maxWidth",1e5),S.resizable("option","minWidth",0),v(),we(window).on("resize",v)},handles:""};function o(){h.currentFile("focus")}S.resizable(W),u=function(e){var t=S.width(),i=0;C.width(1e5);var n,l,o,a,s=C.children("li:visible").last();s.length&&(i=(n=C.parent().scrollLeft())+s.position().left+s.width()+N,C.width(i),(l=h.currentFile())&&e&&(a=n+(o=we(l.getTabNameId())).position().left,(a-=(t-o.outerWidth())/2)<0&&(a=0),C.parent().finish().animate({scrollLeft:a},"slow"))),i<t&&C.width("")},v=function(){var e,t,i,n,l,o=S.width(),a=d.width(),s=!1;e=0,e+=A.vplVisible?1:0,e+=V.vplVisible?2:0,S.resizable("destroy"),W.handles=["e","w","e","e, w"][e],W.disable=0==e,S.resizable(W),c.width(d.outerWidth()),A.vplVisible?(o+=t=A.outerWidth()+N,100<=t?(a-=t,S.css("left",t)):s=!0):S.css("left",0),V.vplVisible&&(o+=i=V.outerWidth()+N,(a-=i)<100&&(s=!0)),s?(n=d.width()/o,l=0,A.vplVisible&&(l=A.width()*n,A.width(l-N),l+=N,S.css("left",l)),S.width(S.width()*n),V.vplVisible&&V.width(d.width()-(l+S.width()+N))):S.width(a),u(!0),function(){var e=we(window).outerHeight();(e-=d.offset().top+d.height()+(r?I():20))<150&&(e=150),c.height(e);var t=e-3*I();S.height(t),V.vplVisible&&(V.height(t+I()),H.accordion("refresh")),A.vplVisible&&(k.height(t-(z.outerHeight()+I())),A.height(t))}(),h.currentFile("adjustSize")};var O=we.extend({},{close:o},Fe.dialogbaseOptions);function P(e,t){return Fe.showMessage(e,we.extend({},O,t))}a=function(e){return Fe.showErrorMessage(e,{close:o})};var E=we("#vpl_ide_dialog_new");function R(e){if("click"!=e.type&&("keypress"!=e.type||13!=e.keyCode))return!1;E.dialog("close");var t={name:we("#vpl_ide_input_newfilename").val(),contents:"",encoding:0},i=h.addFile(t,!1,f,a);return!!i&&(h.open(i),S.tabs("option","active",h.getTabPos(i)),i.focus(),!0)}var j={};j[y("ok")]=R,j[y("cancel")]=function(){we(this).dialog("close")},E.find("input").on("keypress",R),E.dialog(we.extend({},O,{title:y("create_new_file"),buttons:j}));var B=we("#vpl_ide_dialog_rename");function D(e){("click"==e.type||"keypress"==e.type&&13==e.keyCode)&&(B.dialog("close"),h.renameFile(h.currentFile("getFileName"),we("#vpl_ide_input_renamefilename").val(),a),e.preventDefault())}B.find("input").on("keypress",D),j[y("ok")]=D,B.dialog(we.extend({},O,{open:function(){we("#vpl_ide_input_renamefilename").val(h.currentFile("getFileName"))},title:y("rename_file"),buttons:j})),j[y("ok")]=function(){we(this).dialog("close")};var K=we("#vpl_ide_dialog_comments");K.dialog(we.extend({},O,{title:y("comments"),width:"40em",buttons:j})),we("#vpl_ide_input_comments").width("30em");var q=we("#vpl_ide_dialog_about"),U={};U[y("ok")]=function(){we(this).dialog("close")};var G=we("#vpl_ide_dialog_shortcuts");G.dialog(we.extend({},O,{open:function(){var e=M.getShortcuts(h.currentFile("getEditor"));we("#vpl_ide_dialog_shortcuts").html(e)},title:y("shortcuts"),width:400,height:300,buttons:U})),G.dialog("option","height",300),U[y("shortcuts")]=function(){we(this).dialog("close"),G.dialog("open")},q.dialog(we.extend({},O,{open:function(){var e=M.getShortcuts(h.currentFile("getEditor"));q.next().find("button").filter(function(){return we(this).text()==y("shortcuts")}).button(""!=e?"enable":"disable")},title:y("about"),width:400,height:300,buttons:U})),q.dialog("option","height",300);var J=we("#vpl_ide_dialog_sort"),X={};X[y("ok")]=function(){var t=h.getFiles(),i=/[^\d]*/,n=[],e=0,l=we("#vpl_sort_list li");if(l.length==t.length){for(l.each(function(){var e=parseInt(this.id.replace(i,""));n.push(t[e])}),e=0;e<l.length;e++)t[e]=n[e];h.setModified(),Fe.delay("updateMenu",f),Fe.delay("updateFileList",h.updateFileList),we(this).dialog("close")}},X[y("cancel")]=function(){we(this).dialog("close")},J.dialog(we.extend({},O,{title:y("sort"),buttons:X,open:function(){var e=we("#vpl_sort_list");e.html("");for(var t=h.getFiles(),i=0;i<t.length;i++){var n=we('<li id="vpl_fsort_'+i+'"class="ui-widget-content"></li>');i<m&&n.addClass("ui-state-disabled"),n.text(i+1+"-"+t[i].getFileName()),e.append(n)}e.sortable({items:"li:not(.ui-state-disabled)",placeholder:"ui-state-highlight",start:function(e,t){t.item.addClass("ui-state-highlight")},stop:function(e,t){t.item.removeClass("ui-state-highlight")}}),e.disableSelection()},maxHeight:400}));var Y=we("#vpl_ide_dialog_multidelete"),Q={};Q[y("selectall")]=function(){we(this).find("input").prop("checked",!0)},Q[y("deselectall")]=function(){we(this).find("input").prop("checked",!1)},Q[y("deleteselected")]=function(){var i=h.getFiles(),n=[];we("#vpl_multidelete_list label").each(function(){var e,t=we(this);t.find("input").prop("checked")&&(e=t.data("fileid"),n.push(i[e].getFileName()))});for(var e=0;e<n.length;e++)h.deleteFile(n[e],!1,a);Fe.delay("updateMenu",f),Fe.delay("updateFileList",h.updateFileList),we(this).dialog("close")},Q[y("cancel")]=function(){we(this).dialog("close")},Y.dialog(we.extend({},O,{title:y("multidelete"),buttons:Q,open:function(){var e=we("#vpl_multidelete_list");e.html("");for(var t=h.getFiles(),i=m;i<t.length;i++){var n=Fe.sanitizeText(t[i].getFileName()),l=we('<label><input type="checkbox"> '+n+"</label>");l.data("fileid",i),e.append(l),e.append("<br>")}e.find("label").button()},maxHeight:400,maxWidth:400}));var Z=we("#vpl_ide_dialog_fontsize"),$=we("#vpl_ide_dialog_fontsize .vpl_fontsize_slider"),ee={};ee[y("ok")]=function(){var e=$.slider("value");h.setFontSize(e),we(this).dialog("close"),we.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify({fontSize:e}),contentType:"application/json; charset=utf-8",dataType:"json"})},ee[y("cancel")]=function(){h.setFontSize($.data("vpl_fontsize")),we(this).dialog("close")},ee[y("reset")]=function(){$.slider("value",12)},Z.dialog(we.extend({},O,{title:y("fontsize"),buttons:ee,open:function(){$.data("vpl_fontsize",h.getFontSize()),$.slider("value",h.getFontSize())}})),$.slider({min:1,max:48,change:function(){var e=$.slider("value");h.setFontSize(e),Z.find(".vpl_fontsize_slider_value").text(e)}});var te=we("#vpl_ide_dialog_acetheme"),ie=we("#vpl_ide_dialog_acetheme select"),ne={};ne[y("ok")]=function(){h.setTheme(ie.val()),we(this).dialog("close"),Fe.setUserPreferences({aceTheme:ie.val()})},ne[y("cancel")]=function(){h.setTheme(ie.data("acetheme")),we(this).dialog("close")},ne[y("reset")]=function(){ie.val(ie.data("acetheme")),h.setTheme(ie.val())},te.dialog(we.extend({},O,{title:y("theme"),buttons:ne,modal:!1,open:function(){ie.data("acetheme",h.getTheme()),ie.val(h.getTheme())}})),ie.on("change",function(){h.setTheme(ie.val())});var le=new xe("vpl_dialog_terminal","vpl_terminal",y),oe=new Le("vpl_dialog_vnc",y),ae=le,se=we("#vpl_ide_input_file");function re(){Fe.requestAction("resetfiles","",{},p.ajaxurl).done(function(e){var t=e.files;for(var i in t)t.hasOwnProperty(i)&&h.addFile(t[i],!0,Fe.doNothing,a);h.fileListVisibleIfNeeded(),Fe.delay("updateMenu",f)}).fail(a)}se.on("change",function(){Fe.readSelectedFiles(this.files,function(e){return h.addFile(e,!0,f,a)},function(){h.fileListVisibleIfNeeded()})}),M.add({name:"filelist",originalAction:function(){h.fileListVisible(!h.isFileListVisible()),Fe.delay("updateMenu",f),Fe.delay("autoResizeTab",v),Fe.delay("updateFileList",h.updateFileList)},bindKey:{win:"Ctrl-L",mac:"Ctrl-L"}}),M.add({name:"new",originalAction:function(){h.length()<_&&E.dialog("open")},bindKey:{win:"Alt-N",mac:"Option-N"}}),M.add({name:"rename",originalAction:function(){var e=h.currentFile();e&&h.getFilePosById(e.getId())>=m&&B.dialog("open")},bindKey:{win:"Ctrl-R",mac:"Ctrl-R"}}),M.add({name:"delete",originalAction:function(){var e,t=h.currentFile();t&&(e=t.getFileName(),P(y("delete_file_fq",e),{ok:function(){h.deleteFile(e,a)},title:y("delete_file_q"),icon:"trash"}))},bindKey:{win:"Ctrl-D",mac:"Ctrl-D"}}),M.add({name:"close",originalAction:function(){var e=h.currentFile();e&&h.close(e)},bindKey:{win:"Alt-W",mac:"Option-W"}}),M.add({name:"import",originalAction:function(){se.val(""),se.trigger("click")},bindKey:{win:"Ctrl-I",mac:"Ctrl-I"}}),M.add({name:"sort",originalAction:function(){J.dialog("open")},bindKey:{win:"Ctrl-O",mac:"Ctrl-O"}}),M.add({name:"multidelete",originalAction:function(){Y.dialog("open")}}),M.add({name:"fontsize",originalAction:function(){Z.dialog("open")}}),M.add({name:"theme",originalAction:function(){te.dialog("open")}}),M.add({name:"print",originalAction:function(){window.print()},bindKey:{win:"Alt-P",mac:"Command-P"}}),M.add({name:"undo",originalAction:function(){h.currentFile("undo")}}),M.add({name:"redo",originalAction:function(){h.currentFile("redo")}}),M.add({name:"select_all",editorName:"selectall",originalAction:function(){h.currentFile("selectAll")}}),M.add({name:"find",originalAction:function(){h.currentFile("find")}}),M.add({name:"find_replace",editorName:"replace",originalAction:function(){h.currentFile("replace")}}),M.add({name:"next",editorName:"findnext",originalAction:function(){h.currentFile("next")}}),M.add({name:"fullscreen",originalAction:function(){var e="header, nav, footer, aside, .dropdown, #page-header, div.navbar, #nav-drawer";e+=", div.tabtree, #dock, .breadcrumb-nav, .moodle-actionmenu",r=r?(t.removeClass("vpl_ide_root_fullscreen"),we("body").removeClass("vpl_body_fullscreen"),M.setText("fullscreen","fullscreen"),we(e).show(),we("#vpl_ide_user").hide(),!1):(we("body").addClass("vpl_body_fullscreen").scrollTop(0),we(e).hide(),t.addClass("vpl_ide_root_fullscreen"),M.setText("fullscreen","regularscreen"),p.username&&we("#vpl_ide_user").show(),!0),o(),setTimeout(v,10)},bindKey:{win:"Alt-F",mac:"Ctrl-F"}}),M.add({name:"download",originalAction:function(){window.location=p.download}}),M.add({name:"resetfiles",originalAction:function(){P(y("sureresetfiles"),{title:y("resetfiles"),ok:re})}}),M.add({name:"save",originalAction:function(){var i={files:h.getFilesToSave(),comments:we("#vpl_ide_input_comments").val(),version:h.getVersion()};!function t(){Fe.requestAction("save","saving",i,p.ajaxurl).done(function(e){e.oldversion?P(e.question,{title:y("save"),ok:function(){i.version=e.version,t()}}):(h.resetModified(),h.setVersion(e.version),M.setTimeLeft(e),Fe.delay("updateMenu",f))}).fail(a)}()},bindKey:{win:"Ctrl-S",mac:"Command-S"}});var de={getConsole:function(){return ae},setResult:g.setResult,ajaxurl:p.ajaxurl,run:function(e,t,i){ae&&ae.isOpen()&&ae.close(),"terminal"==e?(ae=le).connect(t.executionURL,function(){i.close(),o()}):(ae=oe).connect(t.secure,t.server,t.portToUse,t.VNCpassword,t.executionPath,function(){i.close(),o()})},lastAction:!1,getLastAction:function(){var e=this.lastAction;return this.lastAction=!1,e},setLastAction:function(e){this.lastAction=e}};function ce(t,i,e){e=e||{},ae.isConnected()||Fe.requestAction(t,"",e,p.ajaxurl).done(function(e){Fe.webSocketMonitor(e,t,i,de)}).fail(a)}function ue(){ce("run","running",{XGEOMETRY:oe.getCanvasSize()})}function fe(){ce("debug","debugging",{XGEOMETRY:oe.getCanvasSize()})}function pe(){ce("evaluate","evaluating")}M.add({name:"run",originalAction:function(){de.setLastAction(ue),ue()},bindKey:{win:"Ctrl-F11",mac:"Command-U"}}),M.add({name:"debug",originalAction:function(){de.setLastAction(fe),fe()},bindKey:{win:"Alt-F11",mac:"Option-U"}}),M.add({name:"evaluate",originalAction:function(){de.setLastAction(pe),pe()},bindKey:{win:"Shift-F11",mac:"Command-Option-U"}}),M.add({name:"comments",originalAction:function(){K.dialog("open")}}),M.add({name:"console",originalAction:function(){ae.isOpen()?ae.close():ae.show()}}),M.add({name:"user"}),M.add({name:"about",originalAction:function(){q.dialog("open")}}),M.add({name:"timeleft",originalAction:function(){M.toggleTimeLeft()}}),M.add({name:"more",originalAction:function(){var e=we("#vpl_ide_menuextra");e.is(":visible")?(M.setText("more","more",Fe.str("more")),e.hide()):(M.setText("more","less",Fe.str("less")),e.show()),Fe.delay("updateMenu",f),Fe.delay("autoResizeTab",v)}}),d.addClass("ui-widget-header ui-corner-all");var he="";he+=M.getHTML("more"),he+=M.getHTML("save"),he+="<span id='vpl_ide_mexecution'>",he+=M.getHTML("run"),he+=M.getHTML("debug"),he+=M.getHTML("evaluate"),he+=M.getHTML("comments"),he+=M.getHTML("console"),he+="</span> ",he+="<span id='vpl_ide_menuextra'>",he+="<span id='vpl_ide_file'>",he+=M.getHTML("filelist"),he+=M.getHTML("new"),he+=M.getHTML("rename"),he+=M.getHTML("delete"),he+=M.getHTML("import"),he+=M.getHTML("download"),he+=M.getHTML("resetfiles"),he+=M.getHTML("sort"),he+=M.getHTML("multidelete"),he+=M.getHTML("fontsize"),he+=M.getHTML("theme"),he+="</span> ",he+="<span id='vpl_ide_edit'>",he+=M.getHTML("undo"),he+=M.getHTML("redo"),he+=M.getHTML("select_all"),he+=M.getHTML("find"),he+=M.getHTML("find_replace"),he+=M.getHTML("next"),he+="</span> ",he+="</span> ",he+=M.getHTML("fullscreen")+" ",he+=M.getHTML("about")+" ",he+=M.getHTML("user")+" ",he+=M.getHTML("timeleft"),he+='<div class="clearfix"></div>',d.append(he),we("#vpl_ide_more").button(),we("#vpl_ide_save").button(),we("#vpl_ide_menuextra").hide(),we("#vpl_ide_file").controlgroup(),we("#vpl_ide_edit").controlgroup(),we("#vpl_ide_mexecution").controlgroup(),we("#vpl_ide_fullscreen").button(),we("#vpl_ide_acetheme").button(),we("#vpl_ide_about").button(),we("#vpl_ide_user").button().css("float","right").hide(),we("#vpl_ide_timeleft").button().css("float","right").hide(),we("#vpl_menu .ui-button").css("padding","6px"),we("#vpl_menu .ui-button-text").css("padding","0");for(var ve=["filelist","more","fullscreen","about","resetfiles","download","comments","console","import","fontsize","timeleft"],ge=0;ge<ve.length;ge++)M.enable(ve[ge],!0);M.setExtracontent("user",p.username),M.setTimeLeft(p),f=function(){var e,t=h.currentFile(),i=h.length();i?S.show():S.hide(),h.isFileListVisible()?M.setText("filelist","filelistclose",Fe.str("filelist")):M.setText("filelist","filelist",Fe.str("filelist")),Fe.log("updateMenu",!0);var n,l=h.isModified();if(M.enable("save",l),M.enable("run",(!l||p.example)&&s("run")),M.enable("debug",(!l||p.example)&&s("debug")),M.enable("evaluate",(!l||p.example)&&s("evaluate")),M.enable("download",!l),M.enable("new",i<_),M.enable("sort",1<i-m),M.enable("multidelete",1<i-m),M.enable("theme",!0),t&&0!==i){var o=h.getFilePosById(t.getId());M.enable("rename",m<=o&&0!==i),M.enable("delete",m<=o&&0!==i),M.enable("undo",t.hasUndo()),M.enable("redo",t.hasRedo()),M.enable("select_all",t.hasSelectAll()),M.enable("find",t.hasFind()),M.enable("find_replace",t.hasFindReplace()),M.enable("next",t.hasNext()),Fe.delay("updateFileList",h.updateFileList)}else for(n=["rename","delete","undo","redo","select_all","find","find_replace","next"],e=0;e<n.length;e++)M.enable(n[e],!1)},S.on("tabsactivate",function(){h.currentFile("focus"),Fe.delay("updateMenu",f),Fe.delay("autoResizeTab",v)});var me,_e=we(window);function be(){var e=d.width();me!=e&&(me=e,v())}_e.on("resize",v),p.example||_e.on("beforeunload",function(){return h.isModified()?y("changesNotSaved"):""}),h=new function(){var t,i=we("#vpl_tabs_ul"),o=we("#vpl_tabs").tabs("widget"),s=[],a=[],n=!0,r=this;function d(e){for(var t=e.toLowerCase()+"/",i=0;i<s.length;i++){var n=s[i].getFileName().toLowerCase()+"/";if(0===n.indexOf(t)||0===t.indexOf(n))return 1}}function c(e,t){if(!Fe.isBlockly(e)&&Fe.isBlockly(t))for(var i=0;i<s.length;i++)if(Fe.isBlockly(s[i].getFileName()))return 1}r.setVersion=function(e){t=e},r.getVersion=function(){return t},this.updateFileList=function(){r.generateFileList()},this.fileNameExists=function(e){for(var t=e.toLowerCase(),i=0;i<s.length;i++)if(s[i].getFileName().toLowerCase()==t)return i;return-1},this.restrictedPaste=L,this.dropHandler=x,this.dragoverHandler=T,this.readOnly=w,this.restrictedEdit=b,this.adjustTabsTitles=u,this.minNumberOfFiles=m,this.scrollBarWidth=F;var l="";this.setClipboard=function(e){l=e},this.getClipboard=function(){return l},this.getTabPos=function(e){for(var t=0;t<a.length;t++)if(a[t]==e)return t;return a.length},this.getTheme=function(){return p.theme},this.setTheme=function(e){p.theme=e;for(var t=0;t<s.length;t++)s[t].setTheme(e)},this.addTab=function(e){var t='<a href="#vpl_file'+e+'"></a>';i.append('<li id="vpl_tab_name'+e+'">'+t+"</li>"),o.append('<div id="vpl_file'+e+'" class="vpl_ide_file"></div>')},this.removeTab=function(e){i.find("#vpl_tab_name"+e).remove(),o.find("#vpl_file"+e).remove()},this.open=function(e){var t,i="object"==typeof e?e:s[e];i.isOpen()||(t=i.getId(),r.addTab(t),a.push(i),M.setGetkeys(i.open()),o.tabs("refresh"),u(!1),Fe.delay("updateMenu",f),Fe.delay("updateFileList",r.updateFileList))},this.close=function(e){if(e.isOpen()){var t,i=e.getId();e.close(),r.removeTab(i);var n=r.getTabPos(e);return a.splice(n,1),o.tabs("refresh"),u(!1),r.fileListVisible(!0),Fe.delay("updateFileList",r.updateFileList),Fe.delay("adjustTabsTitles",u,!1),a.length>n?(t=r.getFilePosById(a[n].getId()),void r.gotoFile(t,"c")):0<n?(t=r.getFilePosById(a[n-1].getId()),void r.gotoFile(t,"c")):void 0}},this.isClosed=function(e){return!s[e].isOpen()},this.fileListVisible=function(e){e!==A.vplVisible&&((A.vplVisible=e)?A.show():A.hide(),v())},this.isFileListVisible=function(){return A.vplVisible},this.fileListVisibleIfNeeded=function(){if(!this.isFileListVisible())for(var e=0;e<s.length;e++)if(!s[e].isOpen())return void this.fileListVisible(!0)},this.setFontSize=function(e){p.fontSize=e;for(var t=0;t<s.length;t++)s[t].setFontSize(e);le.setFontSize(e)},this.getFontSize=function(){return p.fontSize},this.addFile=function(e,t,i,n){if("string"!=typeof e.name||!Fe.validPath(e.name))return n(y("incorrect_file_name")+" ("+e.name+")"),!1;!0!==t&&(t=!1);var l=this.fileNameExists(e.name);if(-1!=l)return t?(s[l].setContent(e.contents),r.setModified(),i(),Fe.delay("updateFileList",r.updateFileList),e):(n(y("filenotadded",e.name)),!1);if(d(e.name)||c("",e.name))return n(y("filenotadded",e.name)),!1;if(s.length>=_)return n(y("maxfilesexceeded")+" ("+_+")"),!1;var o=Fe.getUniqueId(),a=new ye(o,e.name,e.contents,this,Me);return 1==e.encoding?a.extendToBinary():Fe.isBlockly(e.name)?a.extendToBlockly():a.extendToCodeEditor(),s.push(a),r.setModified(),5<s.length&&r.fileListVisible(!0),i(),Fe.delay("updateFileList",r.updateFileList),a},this.renameFile=function(e,t,i){var n=this.fileNameExists(e);try{if(-1==n)throw new Error("Internal error: File name not found");if(n<m)throw new Error("Internal error: Renaming requested filename");if(s[n].getFileName()==t)return!0;if(!Fe.validPath(t)||d(t)||c(e,t))throw y("incorrect_file_name");if(Fe.isBinary()&&Fe.fileExtension(e)!=Fe.fileExtension(t))throw y("incorrect_file_name");if(!Fe.isBlockly(e)&&Fe.isBlockly(t)||Fe.isBlockly(e)&&!Fe.isBlockly(t))throw y("incorrect_file_name");s[n].setFileName(t)}catch(e){return i(y("filenotrenamed",t)+": "+e),!1}return r.setModified(),u(!1),Fe.delay("updateFileList",r.updateFileList),!0},this.deleteFile=function(e,t,i){var n=this.fileNameExists(e);return-1==n||n<m?(i(y("filenotdeleted",e)),!1):(r.setModified(),r.close(s[n]),s.splice(n,1),Fe.delay("updateFileList",r.updateFileList),!0)},this.currentFile=function(){var e=o.tabs("option","active");if(e in a){var t=a[e];if(0===arguments.length)return t;var i=arguments[0];if("function"==typeof t[i]){var n=t[i],l=Array.prototype.slice(arguments);return l.shift(),n.apply(t,l)}}return!1},this.currentPos=function(){return o.tabs("option","active")},this.getFileTab=function(e){for(var t=0;t<a.length;t++)if(a[t].getId()==e)return t;return-1},this.getFilePosById=function(e){for(var t=0;t<s.length;t++)if(s[t].getId()==e)return t;return-1},this.gotoFile=function(e,t){var i=s[e];r.open(i),o.tabs("option","active",r.getFileTab(i.getId())),"c"!==t&&i.gotoLine(parseInt(t,10)),i.focus()},this.gotoFileLink=function(e){var t,i=we(e),n=i.data("file"),l=-1;0<=(l=""<n?this.fileNameExists(n):r.getFilePosById(i.data("fileid")))&&(void 0===(t=i.data("line"))&&(t="c"),r.gotoFile(l,t))},this.getFilesToSave=function(){for(var e=[],t=0;t<s.length;t++){var i={};i.name=s[t].getFileName(),i.contents=s[t].getContent(),i.encoding=s[t].isBinary()?1:0,e.push(i)}return e},this.resetModified=function(){n=!1;for(var e=0;e<s.length;e++)s[e].resetModified();Fe.delay("updateMenu",f),Fe.delay("updateFileList",r.updateFileList)},this.setModified=function(){n||(n=!0,Fe.delay("updateFileList",r.updateFileList)),Fe.delay("updateMenu",f)},this.isModified=function(){return n},this.length=function(){return s.length},this.clearAnnotations=function(){for(var e=0;e<s.length;e++)s[e].clearAnnotations()},this.getFile=function(e){return s[e]},this.getFiles=function(){return s},this.getDirectoryStructure=function(){var e={isDir:!0,content:{}};for(var t in s)if(s.hasOwnProperty(t)){var i,n=s[t],l=n.getFileName().split("/"),o=e;for(var a in l){l.hasOwnProperty(a)&&(i=l[a],a==l.length-1?o.content[i]={isDir:!1,content:n,pos:t}:(o.content[i]||(o.content[i]={isDir:!0,content:{}}),o=o.content[i]))}}return e},this.generateFileList=function(){if(r.isFileListVisible()){var c='<span class="vpl_ide_dirindent"></span>',e=[],t="";!function e(t,i,n){for(var l in t.content){var o,a,s,r,d;t.content.hasOwnProperty(l)&&((o=t.content[l]).isDir?(n.push(i+Fe.iconFolder()+Fe.sanitizeText(l)),e(o,i+c,n)):(a=o.content,s=Fe.sanitizeText(l),r=Fe.sanitizeText(a.getFileName()),a.isOpen()&&(s="<b>"+s+"</b>"),d='<a href="#" data-fileid="'+a.getId()+'" title="'+r+'">'+s+"</a>",a.isModified()&&(d=Fe.iconModified()+d),o.pos<m&&(d+=Fe.iconRequired()),n.push(i+d)))}}(r.getDirectoryStructure(),"",e);for(var i=0;i<e.length;i++)t+=e[i]+"<br />";k.html("<div>"+t+"</div>")}},i.on("click","span.vpl_ide_closeicon",function(){h.close(h.currentFile())}),i.on("dblclick","span.vpl_ide_closeicon",M.getAction("delete")),i.on("dblclick","a",M.getAction("rename")),k.on("dblclick","a",M.getAction("rename"))},v(),me=d.width(),be(),setInterval(be,1e3),h.resetModified(),Fe.requestAction("load","loading",p,p.loadajaxurl).done(function(e){for(var t=!0,i=e.files,n=0;n<i.length;n++){var l=i[n],o=h.addFile(l,!1,f,a);o?(o.resetModified(),n<m||i.length<=5?h.open(o):h.fileListVisible(!0)):t=!1}Fe.delay("updateMenu",f),h.generateFileList(),S.tabs("option","active",0),e.compilationexecution&&g.setResult(e.compilationexecution,!1),M.setTimeLeft(e),""<e.comments&&we("#vpl_ide_input_comments").val(e.comments),t?h.resetModified():h.setModified(),0===h.length()&&0<_?M.getAction("new")():p.saved||h.setModified(),h.setFontSize(p.fontSize),h.setVersion(e.version)}).fail(a)};return window.VPLIDE=i,{init:function(e,t){Me=new i(e,t)}}});