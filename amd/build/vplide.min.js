define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplidefile","mod_vpl/vplidebutton","mod_vpl/vplterminal","mod_vpl/vplvnc"],function(a,b,c,d,e,f,g){if("undefined"!=typeof i)return i;var h,i=function(b,i){function j(a){return!Q[a]||i[a]}function k(a){K?a.originalEvent.dataTransfer.dropEffect="none":a.originalEvent.dataTransfer.dropEffect="copy",a.preventDefault()}function l(a){if(K)return a.stopImmediatePropagation(),!1;var b=a.originalEvent.dataTransfer;return b.files.length>0?(c.readSelectedFiles(b.files,function(a){return C.addFile(a,!0,G,F)},function(){C.fileListVisibleIfNeeded()}),a.stopImmediatePropagation(),!1):void 0}function m(a){if(K)return a.stopPropagation(),!1}function n(a,b){if("newHeader"in b&&b.newHeader.hasClass("vpl_ide_accordion_t_grade"))return!1}function o(){function b(a){for(var b=a.toLowerCase()+"/",c=0;c<j.length;c++){var d=j[c].getFileName().toLowerCase()+"/";if(0===d.indexOf(b)||0===b.indexOf(d))return!0}return!1}function e(a,b){if(c.isBlockly(a))return!1;if(c.isBlockly(b))for(var d=0;d<j.length;d++)if(c.isBlockly(j[d].getFileName()))return!0;return!1}var f=a("#vpl_tabs_ul"),g=a("#vpl_tabs").tabs("widget"),j=[],n=[],o=!0,p=this;this.updateFileList=function(){p.generateFileList()},this.fileNameExists=function(a){for(var b=a.toLowerCase(),c=0;c<j.length;c++)if(j[c].getFileName().toLowerCase()==b)return c;return-1},this.restrictedPaste=m,this.dropHandler=l,this.dragoverHandler=k,this.readOnly=L,this.restrictedEdit=K,this.adjustTabsTitles=D,this.minNumberOfFiles=I,this.scrollBarWidth=N;var q="";this.setClipboard=function(a){q=a},this.getClipboard=function(){return q},this.getTabPos=function(a){for(var b=0;b<n.length;b++)if(n[b]==a)return b;return n.length},this.getTheme=function(){return i.theme},this.addTab=function(a){var b='<a href="#vpl_file'+a+'"></a>';f.append('<li id="vpl_tab_name'+a+'">'+b+"</li>"),g.append('<div id="vpl_file'+a+'" class="vpl_ide_file"></div>')},this.removeTab=function(a){f.find("#vpl_tab_name"+a).remove(),g.find("#vpl_file"+a).remove()},this.open=function(a){var b;if(b="object"==typeof a?a:j[a],!b.isOpen()){var d=b.getId();p.addTab(d),n.push(b),S.setGetkeys(b.open()),g.tabs("refresh"),D(!1),c.delay("updateMenu",G),c.delay("updateFileList",p.updateFileList)}},this.close=function(a){if(a.isOpen()){var b,d=a.getId();a.close(),p.removeTab(d);var e=p.getTabPos(a);return n.splice(e,1),g.tabs("refresh"),D(!1),p.fileListVisible(!0),c.delay("updateFileList",p.updateFileList),c.delay("adjustTabsTitles",D,!1),n.length>e?(b=p.getFilePosById(n[e].getId()),void p.gotoFile(b,"c")):e>0?(b=p.getFilePosById(n[e-1].getId()),void p.gotoFile(b,"c")):void 0}},this.isClosed=function(a){return!j[a].isOpen()},this.fileListVisible=function(a){a!==U.vpl_visible&&(U.vpl_visible=a,a?(U.show(),E()):(U.hide(),E()))},this.isFileListVisible=function(){return U.vpl_visible},this.fileListVisibleIfNeeded=function(){if(!this.isFileListVisible())for(var a=0;a<j.length;a++)if(!j[a].isOpen())return void this.fileListVisible(!0)},this.setFontSize=function(a){i.fontSize=a;for(var b=0;b<j.length;b++)j[b].setFontSize(a)},this.getFontSize=function(){return i.fontSize},this.addFile=function(a,f,g,i){if("string"!=typeof a.name||!c.validPath(a.name))return i(O("incorrect_file_name")+" ("+a.name+")"),!1;f!==!0&&(f=!1);var k=this.fileNameExists(a.name);if(k!=-1)return f?(j[k].setContent(a.contents),p.setModified(),g(),c.delay("updateFileList",p.updateFileList),a):(i(O("filenotadded").replace(/\{\$a\}/g,a.name)),!1);if(b(a.name)||e("",a.name))return i(O("filenotadded").replace(/\{\$a\}/g,a.name)),!1;if(j.length>=J)return i(O("maxfilesexceeded")+" ("+J+")"),!1;var l=c.getUniqueId(),m=new d(l,a.name,a.contents,this,h);return 1==a.encoding?m.extendToBinary():c.isBlockly(a.name)?m.extendToBlockly():m.extendToCodeEditor(),j.push(m),p.setModified(),j.length>5&&p.fileListVisible(!0),g(),c.delay("updateFileList",p.updateFileList),m},this.renameFile=function(a,d,f){var g=this.fileNameExists(a);try{if(g==-1)throw"";if(g<I)throw"";if(j[g].getFileName()==d)return!0;if(!c.validPath(d)||b(d)||e(a,d))throw O("incorrect_file_name");if(c.isBinary()&&c.fileExtension(a)!=c.fileExtension(d))throw O("incorrect_file_name");if(!c.isBlockly(a)&&c.isBlockly(d)||c.isBlockly(a)&&!c.isBlockly(d))throw O("incorrect_file_name");j[g].setFileName(d)}catch(h){return f(O("filenotrenamed").replace(/\{\$a\}/g,d)+": "+h),!1}return p.setModified(),D(!1),c.delay("updateFileList",p.updateFileList),!0},this.deleteFile=function(a,b,d){var e=this.fileNameExists(a);return e==-1?(d(O("filenotdeleted").replace(/\{\$a\}/g,a)),!1):e<I?(d(O("filenotdeleted").replace(/\{\$a\}/g,a)),!1):(p.setModified(),p.close(j[e]),j.splice(e,1),c.delay("updateFileList",p.updateFileList),!0)},this.currentFile=function(){var a=g.tabs("option","active");if(a in n){var b=n[a];if(0===arguments.length)return b;var c=arguments[0];if("function"==typeof b[c]){var d=b[c],e=Array.prototype.slice(arguments);return e.shift(),d.apply(b,e)}}return!1},this.currentPos=function(){return g.tabs("option","active")},this.getFileTab=function(a){for(var b=0;b<n.length;b++)if(n[b].getId()==a)return b;return-1},this.getFilePosById=function(a){for(var b=0;b<j.length;b++)if(j[b].getId()==a)return b;return-1},this.gotoFile=function(a,b){var c=j[a];p.open(c),g.tabs("option","active",p.getFileTab(c.getId())),"c"!==b&&c.gotoLine(parseInt(b,10)),c.focus()},this.gotoFileLink=function(b){var c=a(b),d=c.data("file"),e=-1;if(e=d>""?this.fileNameExists(d):p.getFilePosById(c.data("fileid")),e>=0){var f=c.data("line");"undefined"==typeof f&&(f="c"),p.gotoFile(e,f)}},this.getFilesToSave=function(){for(var a=[],b=0;b<j.length;b++){var c={};c.name=j[b].getFileName(),c.contents=j[b].getContent(),c.encoding=j[b].isBinary()?1:0,a.push(c)}return a},this.resetModified=function(){o=!1;for(var a=0;a<j.length;a++)j[a].resetModified();c.delay("updateMenu",G),c.delay("updateFileList",p.updateFileList)},this.setModified=function(){o||(o=!0,c.delay("updateFileList",p.updateFileList)),c.delay("updateMenu",G)},this.isModified=function(){return o},this.length=function(){return j.length},this.clearAnnotations=function(){for(var a=0;a<j.length;a++)j[a].clearAnnotations()},this.getFile=function(a){return j[a]},this.getFiles=function(){return j},this.getDirectoryStructure=function(){var a={isDir:!0,content:{}};for(var b in j)if(j.hasOwnProperty(b)){var c=j[b],d=c.getFileName(),e=d.split("/"),f=a;for(var g in e)if(e.hasOwnProperty(g)){var h=e[g];g==e.length-1?f.content[h]={isDir:!1,content:c,pos:b}:(f.content[h]||(f.content[h]={isDir:!0,content:{}}),f=f.content[h])}}return a},this.generateFileList=function(){function a(d,e,f){for(var g in d.content)if(d.content.hasOwnProperty(g)){var h=d.content[g];if(h.isDir)f.push(e+c.iconFolder()+c.sanitizeText(g)),a(h,e+b,f);else{var i=h.content,j=c.sanitizeText(g),k=c.sanitizeText(i.getFileName());i.isOpen()&&(j="<b>"+j+"</b>");var l='href="#" data-fileid="'+i.getId()+'" title="'+k+'"',m="<a "+l+">"+j+"</a>";i.isModified()&&(m=c.iconModified()+m),h.pos<I&&(m+=c.iconRequired()),f.push(e+m)}}}if(p.isFileListVisible()){var b='<span class="vpl_ide_dirindent"></span>',d=p.getDirectoryStructure(),e=[],f="";a(d,"",e);for(var g=0;g<e.length;g++)f+=e[g]+"<br />";W.html("<div>"+f+"</div>")}},f.on("click","span.vpl_ide_closeicon",function(){C.close(C.currentFile())}),f.on("dblclick","span.vpl_ide_closeicon",S.getAction("delete")),f.on("dblclick","a",S.getAction("rename")),W.on("dblclick","a",S.getAction("rename"))}function p(){return _===!1&&(_=(Y.outerWidth(!0)-Y.width())/2),_}function q(a,b){var c,d=b.position.left-b.originalPosition.left;if(0!==d)c=Y.width()+U.width()-U.vpl_minWidth,Y.resizable("option","maxWidth",c),U.width(U.vpl_original_width+d);else{c=Y.width()+Z.width()-Z.vpl_minWidth,Y.resizable("option","maxWidth",c);var e=b.size.width-b.originalSize.width;Z.width(Z.vpl_original_width-e)}C.currentFile("adjustSize")}function r(){var a=["e","w","e","e, w"],b=0;b+=U.vpl_visible?1:0,b+=Z.vpl_visible?2:0,Y.resizable("destroy"),aa.handles=a[b],aa.disable=0===b,Y.resizable(aa)}function s(){var b=a(window).outerHeight();b-=R.offset().top+R.height()+(M?p():20),b<150&&(b=150),T.height(b);var c=b-3*p();Y.height(c),Z.vpl_visible&&(Z.height(c+p()),$.accordion("refresh")),U.vpl_visible&&(W.height(c-(V.outerHeight()+p())),U.height(c))}function t(){C.currentFile("focus")}function u(b,d){return c.showMessage(b,a.extend({},ba,d))}function v(b){if("click"==b.type||"keypress"==b.type&&13==b.keyCode){ca.dialog("close");var c={name:a("#vpl_ide_input_newfilename").val(),contents:"",encoding:0},d=C.addFile(c,!1,G,F);return d&&(C.open(d),Y.tabs("option","active",C.getTabPos(d)),d.focus()),!1}}function w(b){("click"==b.type||"keypress"==b.type&&13==b.keyCode)&&(ea.dialog("close"),C.renameFile(C.currentFile("getFileName"),a("#vpl_ide_input_renamefilename").val(),F),b.preventDefault())}function x(){c.requestAction("resetfiles","",{},i.ajaxurl).done(function(a){var b=a.files;for(var d in b)b.hasOwnProperty(d)&&C.addFile(b[d],!0,c.doNothing,F);C.fileListVisibleIfNeeded(),c.delay("updateMenu",G)}).fail(F)}function y(a,b,d){d||(d={}),sa.isConnected()||c.requestAction(a,"",d,i.ajaxurl).done(function(d){c.webSocketMonitor(d,a,b,va)}).fail(F)}function z(){y("run","running",{XGEOMETRY:ra.getCanvasSize()})}function A(){y("debug","debugging",{XGEOMETRY:ra.getCanvasSize()})}function B(){y("evaluate","evaluating")}var C,D,E,F,G,H=this,I=i.minfiles||0,J=i.maxfiles||0,K=i.restrictededitor||i.example,L=i.example,M=!1,N=c.scrollBarWidth();c.set_str(i.i18n);var O=c.str,P=a("#"+b);if(a("head").append('<meta name="viewport" content="initial-scale=1">').append('<meta name="viewport" width="device-width">').append('<link rel="stylesheet" href="../editor/VPLIDE.css"/>'),"object"!=typeof P)throw"VPL: constructor tag_id not found";var Q={"new":!0,rename:!0,"delete":!0,save:!0,run:!0,edit:!0,debug:!0,evaluate:!0,"import":!0,resetfiles:!0,sort:!0,multidelete:!0,console:!0,comments:!0};"undefined"==typeof i.loadajaxurl&&(i.loadajaxurl=i.ajaxurl),function(){var a=I<J;i["new"]=a,i.rename=a,i["delete"]=a,i.comments=i.comments&&!i.example}(),i.sort=J-I>=2,i.multidelete=i.sort,i["import"]=!K,i.console=j("run")||j("debug"),"undefined"==typeof i.fontSize&&(i.fontSize=12),i.fontSize=parseInt(i.fontSize),P.on("drop",l),P.on("dragover",k);var R=a("#vpl_menu"),S=new e(R,j),T=a("#vpl_tr"),U=a("#vpl_filelist"),V=a("#vpl_filelist_header"),W=a("#vpl_filelist_content"),X=a("#vpl_tabs_ul"),Y=a("#vpl_tabs"),Z=a("#vpl_results"),$=a("#vpl_results_accordion");U.vpl_minWidth=80,Z.vpl_minWidth=100,this.updateEvaluationNumber=function(a){if("undefined"!=typeof a.nevaluations){var b=a.nevaluations;"undefined"!=typeof a.reductionbyevaluation&&a.reductionbyevaluation>""&&0!=a.reductionbyevaluation&&(0!=a.freeevaluations&&(b=b+"/"+a.freeevaluations),b=b+" -"+a.reductionbyevaluation),S.setExtracontent("evaluate",b)}},this.lastResult=null,this.getTerminal=function(){return qa},this.setResultGrade=function(a,b){var c="grade",d="vpl_ide_accordion_t_"+c,e="vpl_ide_accordion_c_"+c;if(0==$.find("."+e).length&&($.append('<div class="'+d+'"></div>'),$.append('<div class="'+e+'"></div>')),"undefined"==typeof b)return $.find("h4."+d).length>0;var f=$.find("."+d);return a>""?(f.replaceWith('<h4 class="'+d+'">'+a+"</h4>"),!0):(f.replaceWith('<div class="'+d+'"></div>'),!1)},this.setResultTab=function(b,c,d){var e="vpl_ide_accordion_t_"+b,f="vpl_ide_accordion_c_"+b;if(0==$.find("."+f).length&&($.append('<div class="'+e+'"></div>'),$.append('<div class="'+f+'"></div>')),"undefined"==typeof d)return $.find("h4."+e).length>0;var g=$.find("."+e),h=$.find("."+f),i=a("<div>"+c+"</div>");return i.find("h4").replaceWith(function(){return a("<h5>").append(a(this).contents())}),h.html()==i.html()?c>"":c>""?(g.replaceWith('<h4 class="'+e+'">'+O(b)+"</h4>"),h.replaceWith('<div class="ui-widget '+f+'">'+i.html()+"</div>"),!0):(g.replaceWith('<div class="'+e+'"></div>'),h.replaceWith('<div class="'+f+'"></div>'),!1)},this.setResult=function(a,b){H.updateEvaluationNumber(a);var d,e=C.getFiles(),f=[];for(d=0;d<e.length;d++)f[d]=e[d].getFileName(),e[d].clearAnnotations();var g,h,j,k=!1,l=c.sanitizeText(a.grade);if(h=H.setResultGrade(l,a.grade),k=k||h,g=H.setResultTab("variables",a.variables,a.variables),k=k||g,j=c.processResult(a.compilation,f,e,!0,!1),g=H.setResultTab("compilation",j,a.compilation),k=k||g,j=c.processResult(a.evaluation,f,e,!1,!1),g=H.setResultTab("comments",j,a.evaluation),k=k||g,j=c.sanitizeText(a.execution),g=H.setResultTab("execution",j,a.execution),k=k||g,g=H.setResultTab("description",i.description,i.description),k=k||g){for(Z.show(),Z.vpl_visible=!0,$.accordion("refresh"),$.accordion("option","active",h?1:0),d=0;d<e.length;d++)for(var m=e[d].getAnnotations(),n=0;n<m.length;n++)if(b||"error"==m[n].type){C.gotoFile(d,m[n].row+1);break}}else Z.hide(),Z.vpl_visible=!1;c.delay("autoResizeTab",E)},$.accordion({heightStyle:"fill",header:"h4",animate:!1,beforeActivate:n}),Z.width(2*Z.vpl_minWidth),$.on("click","a",function(a){a.preventDefault(),C.gotoFileLink(a.currentTarget)}),Z.vpl_visible=!1,Z.hide(),U.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),V.text(O("filelist")),V.html(c.iconFolder()+V.html()),V.addClass("ui-widget-header ui-button-text-only ui-corner-all"),W.addClass("ui-widget ui-corner-all"),U.width(2*U.vpl_minWidth),U.on("click","a",function(a){a.preventDefault(),C.gotoFileLink(a.currentTarget)}),U.vpl_visible=!1,U.hide(),Y.tabs({classes:{"ui-tabs-panel":null}});var _=!1,aa={containment:"parent",resize:q,start:function(){a(window).off("resize",E),Y.resizable("option","minWidth",100),Z.vpl_visible&&(Z.vpl_original_width=Z.width()),U.vpl_visible&&(U.vpl_original_width=U.width())},stop:function(b,c){q(b,c),Y.resizable("option","maxWidth",1e5),Y.resizable("option","minWidth",0),E(),a(window).on("resize",E)},handles:""};Y.resizable(aa),D=function(b){var c=Y.width(),d=0;X.width(1e5);var e=X.children("li:visible").last();if(e.length){var f=X.parent().scrollLeft();d=f+e.position().left+e.width()+_,X.width(d);var g=C.currentFile();if(g&&b){var h=a(g.getTabNameId()),i=f+h.position().left;i-=(c-h.outerWidth())/2,i<0&&(i=0),X.parent().finish().animate({scrollLeft:i},"slow")}}d<c&&X.width("")},E=function(){var a=Y.width(),b=R.width(),c=!1;if(r(),T.width(R.outerWidth()),U.vpl_visible){var d=U.outerWidth()+_;a+=d,d>=100?(b-=d,Y.css("left",d)):c=!0}else Y.css("left",0);if(Z.vpl_visible){var e=Z.outerWidth()+_;a+=e,b-=e,b<100&&(c=!0)}if(c){var f=R.width()/a,g=0;U.vpl_visible&&(g=U.width()*f,U.width(g-_),g+=_,Y.css("left",g)),Y.width(Y.width()*f),Z.vpl_visible&&Z.width(R.width()-(g+Y.width()+_))}else Y.width(b);D(!0),s(),C.currentFile("adjustSize")};var ba=a.extend({},{close:t},c.dialogbase_options);F=function(a){return c.showErrorMessage(a,{close:t})};var ca=a("#vpl_ide_dialog_new"),da={};da[O("ok")]=v,da[O("cancel")]=function(){a(this).dialog("close")},ca.find("input").on("keypress",v),ca.dialog(a.extend({},ba,{title:O("create_new_file"),buttons:da}));var ea=a("#vpl_ide_dialog_rename");ea.find("input").on("keypress",w),da[O("ok")]=w,ea.dialog(a.extend({},ba,{open:function(){a("#vpl_ide_input_renamefilename").val(C.currentFile("getFileName"))},title:O("rename_file"),buttons:da})),da[O("ok")]=function(){a(this).dialog("close")};var fa=a("#vpl_ide_dialog_comments");fa.dialog(a.extend({},ba,{title:O("comments"),width:"40em",buttons:da})),a("#vpl_ide_input_comments").width("30em");var ga=a("#vpl_ide_dialog_about"),ha={};ha[O("ok")]=function(){a(this).dialog("close")};var ia=a("#vpl_ide_dialog_shortcuts");ia.dialog(a.extend({},ba,{open:function(){var b=S.getShortcuts(C.currentFile("getEditor"));a("#vpl_ide_dialog_shortcuts").html(b)},title:O("shortcuts"),width:400,height:300,buttons:ha})),ia.dialog("option","height",300),ha[O("shortcuts")]=function(){a(this).dialog("close"),ia.dialog("open")},ga.dialog(a.extend({},ba,{open:function(){var b=S.getShortcuts(C.currentFile("getEditor"));ga.next().find("button").filter(function(){return a(this).text()==O("shortcuts")}).button(""!=b?"enable":"disable")},title:O("about"),width:400,height:300,buttons:ha})),ga.dialog("option","height",300);var ja=a("#vpl_ide_dialog_sort"),ka={};ka[O("ok")]=function(){var b=C.getFiles(),d=/[^\d]*/,e=[],f=0,g=a("#vpl_sort_list li");if(g.length==b.length){for(g.each(function(){var a=parseInt(this.id.replace(d,""));e.push(b[a])}),f=0;f<g.length;f++)b[f]=e[f];C.setModified(),c.delay("updateMenu",G),c.delay("updateFileList",C.updateFileList),a(this).dialog("close")}},ka[O("cancel")]=function(){a(this).dialog("close")},ja.dialog(a.extend({},ba,{title:O("sort"),buttons:ka,open:function(){var b=a("#vpl_sort_list");b.html("");for(var c=C.getFiles(),d=0;d<c.length;d++){var e=a('<li id="vpl_fsort_'+d+'"class="ui-widget-content"></li>');d<I&&e.addClass("ui-state-disabled"),e.text(d+1+"-"+c[d].getFileName()),b.append(e)}b.sortable({items:"li:not(.ui-state-disabled)",placeholder:"ui-state-highlight",start:function(a,b){b.item.addClass("ui-state-highlight")},stop:function(a,b){b.item.removeClass("ui-state-highlight")}}),b.disableSelection()},maxHeight:400}));var la=a("#vpl_ide_dialog_multidelete"),ma={};ma[O("selectall")]=function(){a(this).find("input").prop("checked",!0)},ma[O("deselectall")]=function(){a(this).find("input").prop("checked",!1)},ma[O("deleteselected")]=function(){var b=C.getFiles(),d=[],e=a("#vpl_multidelete_list label");e.each(function(){var c=a(this);if(c.find("input").prop("checked")){var e=c.data("fileid");d.push(b[e].getFileName())}});for(var f=0;f<d.length;f++)C.deleteFile(d[f],!1,F);c.delay("updateMenu",G),c.delay("updateFileList",C.updateFileList),a(this).dialog("close")},ma[O("cancel")]=function(){a(this).dialog("close")},la.dialog(a.extend({},ba,{title:O("multidelete"),buttons:ma,open:function(){var b=a("#vpl_multidelete_list");b.html("");for(var d=C.getFiles(),e=I;e<d.length;e++){var f=c.sanitizeText(d[e].getFileName()),g=a('<label><input type="checkbox"> '+f+"</label>");g.data("fileid",e),b.append(g),b.append("<br>")}b.find("label").button()},maxHeight:400,maxWidth:400}));var na=a("#vpl_ide_dialog_fontsize"),oa=a("#vpl_ide_dialog_fontsize .vpl_fontsize_slider"),pa={};pa[O("ok")]=function(){var b=oa.slider("value");C.setFontSize(b),a(this).dialog("close"),a.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify({fontSize:b}),contentType:"application/json; charset=utf-8",dataType:"json"})},pa[O("cancel")]=function(){C.setFontSize(oa.data("vpl_fontsize")),a(this).dialog("close")},pa[O("reset")]=function(){oa.slider("value",12)},na.dialog(a.extend({},ba,{title:O("fontsize"),buttons:pa,open:function(){oa.data("vpl_fontsize",C.getFontSize()),oa.slider("value",C.getFontSize())}})),oa.slider({min:1,max:48,change:function(){var a=oa.slider("value");C.setFontSize(a),na.find(".vpl_fontsize_slider_value").text(a)}});var qa=new f("vpl_dialog_terminal","vpl_terminal",O),ra=new g("vpl_dialog_vnc",O),sa=qa,ta=a("#vpl_ide_input_file"),ua=function(){c.readSelectedFiles(this.files,function(a){return C.addFile(a,!0,G,F)},function(){C.fileListVisibleIfNeeded()})};ta.on("change",ua),S.add({name:"filelist",originalAction:function(){C.fileListVisible(!C.isFileListVisible()),c.delay("updateMenu",G),c.delay("autoResizeTab",E),c.delay("updateFileList",C.updateFileList)},bindKey:{win:"Ctrl-L",mac:"Ctrl-L"}}),S.add({name:"new",originalAction:function(){C.length()<J&&ca.dialog("open")},bindKey:{win:"Alt-N",mac:"Option-N"}}),S.add({name:"rename",originalAction:function(){var a=C.currentFile();a&&C.getFilePosById(a.getId())>=I&&ea.dialog("open")},bindKey:{win:"Ctrl-R",mac:"Ctrl-R"}}),S.add({name:"delete",originalAction:function(){var a=C.currentFile();if(a){var b=a.getFileName(),c=O("delete_file_fq").replace(/\{\$a\}/g,b);u(c,{ok:function(){C.deleteFile(b,F)},title:O("delete_file_q"),icon:"trash"})}},bindKey:{win:"Ctrl-D",mac:"Ctrl-D"}}),S.add({name:"close",originalAction:function(){var a=C.currentFile();a&&C.close(a)},bindKey:{win:"Alt-W",mac:"Option-W"}}),S.add({name:"import",originalAction:function(){ta.val(""),ta.trigger("click")},bindKey:{win:"Ctrl-I",mac:"Ctrl-I"}}),S.add({name:"sort",originalAction:function(){ja.dialog("open")},bindKey:{win:"Ctrl-O",mac:"Ctrl-O"}}),S.add({name:"multidelete",originalAction:function(){la.dialog("open")}}),S.add({name:"fontsize",originalAction:function(){na.dialog("open")}}),S.add({name:"print",originalAction:function(){window.print()},bindKey:{win:"Alt-P",mac:"Command-P"}}),S.add({name:"undo",originalAction:function(){C.currentFile("undo")}}),S.add({name:"redo",originalAction:function(){C.currentFile("redo")}}),S.add({name:"select_all",editorName:"selectall",originalAction:function(){C.currentFile("selectAll")}}),S.add({name:"find",originalAction:function(){C.currentFile("find")}}),S.add({name:"find_replace",editorName:"replace",originalAction:function(){C.currentFile("replace")}}),S.add({name:"next",editorName:"findnext",originalAction:function(){C.currentFile("next")}}),S.add({name:"fullscreen",originalAction:function(){var b="header, footer, aside, #page-header, div.navbar, #nav-drawer";b+=", div.tabtree, #dock, .breadcrumb-nav, .moodle-actionmenu",M?(P.removeClass("vpl_ide_root_fullscreen"),a("body").removeClass("vpl_body_fullscreen"),S.setText("fullscreen","fullscreen"),a(b).show(),a("#vpl_ide_user").hide(),M=!1):(a("body").addClass("vpl_body_fullscreen").scrollTop(0),a(b).hide(),P.addClass("vpl_ide_root_fullscreen"),S.setText("fullscreen","regularscreen"),i.username&&a("#vpl_ide_user").show(),M=!0),t(),setTimeout(E,10)},bindKey:{win:"Alt-F",mac:"Ctrl-F"}}),S.add({name:"download",originalAction:function(){window.location=i.download}}),S.add({name:"resetfiles",originalAction:function(){u(O("sureresetfiles"),{title:O("resetfiles"),ok:x})}}),S.add({name:"save",originalAction:function(){var b={files:C.getFilesToSave(),comments:a("#vpl_ide_input_comments").val()};c.requestAction("save","saving",b,i.ajaxurl).done(function(a){C.resetModified(),S.setTimeLeft(a),c.delay("updateMenu",G)}).fail(F)},bindKey:{win:"Ctrl-S",mac:"Command-S"}});var va={getConsole:function(){return sa},setResult:H.setResult,ajaxurl:i.ajaxurl,run:function(a,b,c){"terminal"==a?(sa=qa,qa.connect(b.executionURL,function(){c.close(),t()})):(sa=ra,ra.connect(b.secure,b.server,b.portToUse,b.VNCpassword,b.executionPath,function(){c.close(),t()}))},lastAction:!1,getLastAction:function(){var a=this.lastAction;return this.lastAction=!1,a},setLastAction:function(a){this.lastAction=a}};S.add({name:"run",originalAction:function(){va.setLastAction(z),z()},bindKey:{win:"Ctrl-F11",mac:"Command-U"}}),S.add({name:"debug",originalAction:function(){va.setLastAction(A),A()},bindKey:{win:"Alt-F11",mac:"Option-U"}}),S.add({name:"evaluate",originalAction:function(){va.setLastAction(B),B()},bindKey:{win:"Shift-F11",mac:"Command-Option-U"}}),S.add({name:"comments",originalAction:function(){fa.dialog("open")}}),S.add({name:"console",originalAction:function(){sa.show()}}),S.add({name:"user"}),S.add({name:"about",originalAction:function(){ga.dialog("open")}}),S.add({name:"timeleft",originalAction:function(){S.toggleTimeLeft()}}),S.add({name:"more",originalAction:function(){var b=a("#vpl_ide_menuextra");b.is(":visible")?(S.setText("more","more",c.str("more")),b.hide()):(S.setText("more","less",c.str("less")),b.show()),c.delay("updateMenu",G),c.delay("autoResizeTab",E)}}),R.addClass("ui-widget-header ui-corner-all");var wa="";wa+=S.getHTML("more"),wa+=S.getHTML("save"),wa+="<span id='vpl_ide_mexecution'>",wa+=S.getHTML("run"),wa+=S.getHTML("debug"),wa+=S.getHTML("evaluate"),wa+=S.getHTML("comments"),wa+=S.getHTML("console"),wa+="</span> ",wa+="<span id='vpl_ide_menuextra'>",wa+="<span id='vpl_ide_file'>",wa+=S.getHTML("filelist"),wa+=S.getHTML("new"),wa+=S.getHTML("rename"),wa+=S.getHTML("delete"),wa+=S.getHTML("import"),wa+=S.getHTML("download"),wa+=S.getHTML("resetfiles"),wa+=S.getHTML("sort"),wa+=S.getHTML("multidelete"),wa+=S.getHTML("fontsize"),wa+="</span> ",wa+="<span id='vpl_ide_edit'>",wa+=S.getHTML("undo"),wa+=S.getHTML("redo"),wa+=S.getHTML("select_all"),wa+=S.getHTML("find"),wa+=S.getHTML("find_replace"),wa+=S.getHTML("next"),wa+="</span> ",wa+="</span> ",wa+=S.getHTML("fullscreen")+" ",wa+=S.getHTML("about")+" ",wa+=S.getHTML("user")+" ",wa+=S.getHTML("timeleft"),wa+='<div class="clearfix"></div>',R.append(wa),a("#vpl_ide_more").button(),a("#vpl_ide_save").button(),a("#vpl_ide_menuextra").hide(),a("#vpl_ide_file").buttonset(),a("#vpl_ide_edit").buttonset(),a("#vpl_ide_mexecution").buttonset(),a("#vpl_ide_fullscreen").button(),a("#vpl_ide_about").button(),a("#vpl_ide_user").button().css("float","right").hide(),a("#vpl_ide_timeleft").button().css("float","right").hide(),a("#vpl_menu .ui-button").css("padding","6px"),a("#vpl_menu .ui-button-text").css("padding","0"),S.setExtracontent("user",i.username),S.setTimeLeft(i),G=function(){var a,b=C.currentFile(),d=C.length();d?Y.show():Y.hide(),C.isFileListVisible()?S.setText("filelist","filelistclose",c.str("filelist")):S.setText("filelist","filelist",c.str("filelist")),c.log("updateMenu",!0);var e=C.isModified();S.enable("save",e),S.enable("run",!e),S.enable("debug",!e),S.enable("evaluate",!e),S.enable("download",!e),S.enable("new",d<J),S.enable("sort",d-I>1),S.enable("multidelete",d-I>1);var f;if(b&&0!==d){var g=C.getFilePosById(b.getId());S.enable("rename",g>=I&&0!==d),S.enable("delete",g>=I&&0!==d),S.enable("undo",b.hasUndo()),S.enable("redo",b.hasRedo()),S.enable("select_all",b.hasSelectAll()),S.enable("find",b.hasFind()),S.enable("find_replace",b.hasFindReplace()),S.enable("next",b.hasNext()),c.delay("updateFileList",C.updateFileList)}else for(f=["rename","delete","undo","redo","select_all","find","find_replace","next"],a=0;a<f.length;a++)S.enable(f[a],!1)},Y.on("tabsactivate",function(){C.currentFile("focus"),c.delay("updateMenu",G),c.delay("autoResizeTab",E)});var xa=a(window);xa.on("resize",E),i.example||xa.on("beforeunload",function(){if(C.isModified())return O("changesNotSaved")}),C=new o,E(),function(){function a(){var a=R.width();b!=a&&(b=a,E())}var b=R.width();a(),setInterval(a,1e3)}(),C.resetModified(),c.requestAction("load","loading",i,i.loadajaxurl).done(function(b){for(var d=!0,e=b.files,f=0;f<e.length;f++){var g=e[f],h=C.addFile(g,!1,G,F);h?(h.resetModified(),f<I||e.length<=5?C.open(h):C.fileListVisible(!0)):d=!1}c.delay("updateMenu",G),C.generateFileList(),Y.tabs("option","active",0),b.compilationexecution&&H.setResult(b.compilationexecution,!1),S.setTimeLeft(b),b.comments>""&&a("#vpl_ide_input_comments").val(b.comments),d?C.resetModified():C.setModified(),0===C.length()&&J>0?S.getAction("new")():i.saved||C.setModified()}).fail(F)};return window.VPL_IDE=i,{init:function(a,b){h=new i(a,b)}}});