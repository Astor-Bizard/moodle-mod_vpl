define(["jquery","jqueryui","mod_vpl/vplutil"],function(p,t,v){if(void 0!==e)return e;var e=function(t,n){var o,a,i,r,l,d,s,c,u=this,f={};function m(t){d=5,s=1e3,3600<t?(d=60,s=5e3):86400<t&&(d=300,s=25e3)}function h(){var t,e,n,i=u.multiple(v.getCurrentTime(),d);i!==a&&null!==l&&(e="",(t=c-((a=i)-o))<=0?e="vpl_buttonleft_black":t<=300?(r=!0,e="vpl_buttonleft_red"):t<=900?e="vpl_buttonleft_orange":m(t),n='<span class="'+e+'">'+v.genIcon("timeleft"),r&&(n+=" "+v.getTimeLeft(t)),n+="</span>",l.html(n),l.removeClass("vpl_buttonleft_orange vpl_buttonleft_red vpl_buttonleft_black"),l.addClass(e))}this.notAdded=function(t){return!f[t]},this.setText=function(t,e,n){u.notAdded(t)||(e=e||f[t].icon,n=(n=n||f[t].title)||v.str(e),f[t].icon=e,f[t].title=n,f[t].hasOwnProperty("key")&&(n+=" ("+f[t].key+")"),p("#vpl_ide_"+t).attr("title",n),p("#vpl_ide_"+t+" i").replaceWith(v.genIcon(e)))},this.setExtracontent=function(t,e){var n,i;u.notAdded(t)||(n="bt_extrahtml",0==(i=p("#vpl_ide_"+t+" i")).find("."+n).length&&i.append(' <span class="'+n+'"><span>'),i.find("."+n).html(e))},this.add=function(t){var e;if("string"==typeof t&&(t={name:t}),n(t.name)){if(t.hasOwnProperty("icon")||(t.icon=t.name),t.hasOwnProperty("title")||(t.title=v.str(t.name)),t.hasOwnProperty("active")||(t.active=!0),t.hasOwnProperty("editorName")||(t.editorName=t.name),t.hasOwnProperty("originalAction")||(t.originalAction=v.doNothing),!u.notAdded(t.name))throw new Error("Button already set "+t.name);f[t.name]=t,u.setAction(t.name,t.originalAction),t.hasOwnProperty("bindKey")&&(t.command={name:t.editorName,bindKey:t.bindKey,exec:t.action},e="win",navigator.platform.startsWith("Mac")&&(e="mac"),t.key=t.bindKey[e])}},this.getHTML=function(t){if(u.notAdded(t))return"";var e=f[t].title;f[t].hasOwnProperty("key")&&(e+=" ("+f[t].key+")");var n="<a id='vpl_ide_"+t+"' href='#' title='"+e+"'>";return n+=v.genIcon(t)+"</a>"},this.enable=function(t,e){var n;u.notAdded(t)||(n=p("#vpl_ide_"+t),f[t].active=e,n.data("vpl-active",e),e?n.removeClass("ui-button-disabled ui-state-disabled"):n.addClass("ui-button-disabled ui-state-disabled"))},this.setAction=function(t,e){u.notAdded(t)||(f[t].originalAction=e,f[t].action=function(){f[t].active&&e()})},this.getAction=function(t){return u.notAdded(t)?v.doNothing:f[t].action},this.launchAction=function(t){u.notAdded(t)||f[t].originalAction()},this.setGetkeys=function(t){if(t){var e,n=t.commands.commands,i=t.commands.platform;for(var o in f){f.hasOwnProperty(o)&&(n[e=f[o].editorName]&&n[e].bindKey&&!f[o].Key?(f[o].key=n[e].bindKey[i],u.setText(o)):f[o].bindKey&&!f[o].hasOwnProperty("key")&&(f[o].key=f[o].bindKey[i],u.setText(o)))}}},this.getShortcuts=function(t){var e="<ul>";for(var n in f)f[n].hasOwnProperty("key")&&(e+="<li>",e+=f[n].title+" ("+f[n].key+")",e+="</li>");if(e+="</ul>",t){e+="<h5>"+v.str("edit")+"</h5>";var i=t.commands.commands,o=t.commands.platform;for(var a in e+="<ul>",i)i[a].hasOwnProperty("bindKey")&&""<i[a].bindKey[o]&&(e+="<li>",e+=a+" ("+i[a].bindKey[o]+")",e+="</li>");e+="</ul>"}return"<ul></ul>"==e?"":e},p(t).on("click","a",function(t){if(p(this).data("vpl-active")){var e=p(this).attr("id");if("string"!=typeof e||!e.startsWith("vpl_ide_"))return!0;if(e=e.replace("vpl_ide_",""),u.notAdded(e))return!0;if(f[e]&&!f[e].active)return!0;var n=u.getAction(e);"import"!=e?setTimeout(n,10):n()}return t.stopImmediatePropagation(),!1}),p("body").on("keydown",function(t){var e,n=!1,i="";if(t.shiftKey&&(i+="shift-"),t.altKey&&(i+="alt-",n=!0),t.ctrlKey&&(i+="ctrl-",n=!0),t.metaKey&&(i+="meta-",n=!0),112<=t.which&&t.which<=123?(i+="f"+(t.which-111),n=!0):(e=String.fromCharCode(t.which).toLowerCase())<"a"||"z"<e?n=!1:i+=e,n)for(var o in f)if(f[o].hasOwnProperty("key")&&i==f[o].key.toLowerCase())return t.preventDefault(),t.stopImmediatePropagation(),f[o].action(),!1;return!0}),this.multiple=function(t,e){return t-t%e},r=i=!1,l=null,d=5,s=1e3,c=a=o=0,u.toggleTimeLeft=function(){r=!r,a=0,h()},u.setTimeLeft=function(t){var e;l=p("#vpl_ide_timeleft"),!1!==i&&(clearInterval(i),i=!1),t.hasOwnProperty("timeLeft")?(c=t.timeLeft,m(c),e=c%d,c=u.multiple(c,d),o=u.multiple(v.getCurrentTime(),d),a=o-d,setTimeout(function(){i=setInterval(h,s)},1e3*e),p("#vpl_ide_timeleft").show(),h()):p("#vpl_ide_timeleft").hide()}};return window.VPLIDEButtons=e});