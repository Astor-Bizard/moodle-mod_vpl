define(["jquery","jqueryui","mod_vpl/vplutil"],function(a,b,c){if("undefined"!=typeof d)return d;var d=function(b,d){var e=this,f={};this.notAdded=function(a){return!f[a]},this.setText=function(b,d,g){e.notAdded(b)||(d||(d=f[b].icon),g||(g=f[b].title),g||(g=c.str(d)),f[b].icon=d,f[b].title=g,f[b].hasOwnProperty("key")&&(g+=" ("+f[b].key+")"),a("#vpl_ide_"+b).attr("title",g),a("#vpl_ide_"+b+" i").replaceWith(c.genIcon(d)))},this.setExtracontent=function(b,c){if(!e.notAdded(b)){var d="bt_extrahtml",f=a("#vpl_ide_"+b+" i");0==f.find("."+d).length&&f.append(' <span class="'+d+'"><span>'),f.find("."+d).html(c)}},this.add=function(a){if("string"==typeof a){var b=a;a={name:b}}if(d(a.name)){if(a.hasOwnProperty("icon")||(a.icon=a.name),a.hasOwnProperty("title")||(a.title=c.str(a.name)),a.hasOwnProperty("active")||(a.active=!0),a.hasOwnProperty("editorName")||(a.editorName=a.name),a.hasOwnProperty("originalAction")||(a.originalAction=c.doNothing),!e.notAdded(a.name))throw"Button already set "+a.name;if(f[a.name]=a,e.setAction(a.name,a.originalAction),a.hasOwnProperty("bindKey")){a.command={name:a.editorName,bindKey:a.bindKey,exec:a.action};var g="win";navigator.platform.startsWith("Mac")&&(g="mac"),a.key=a.bindKey[g]}}},this.getHTML=function(a){if(e.notAdded(a))return"";var b=f[a].title;f[a].hasOwnProperty("key")&&(b+=" ("+f[a].key+")");var d="<a id='vpl_ide_"+a+"' href='#' title='"+b+"'>";return d+=c.genIcon(a)+"</a>"},this.enable=function(b,c){if(e.notAdded(b))return"";var d=a("#vpl_ide_"+b);f[b].active=c,d.data("vpl-active",c),c?d.removeClass("ui-button-disabled ui-state-disabled"):d.addClass("ui-button-disabled ui-state-disabled")},this.setAction=function(a,b){e.notAdded(a)||(f[a].originalAction=b,f[a].action=function(){f[a].active&&b()})},this.getAction=function(a){return e.notAdded(a)?c.doNothing:f[a].action},this.launchAction=function(a){e.notAdded(a)||f[a].originalAction()},this.setGetkeys=function(a){if(a){var b=a.commands.commands,c=a.commands.platform;for(var d in f)if(f.hasOwnProperty(d)){var g=f[d].editorName;b[g]&&b[g].bindKey&&!f[d].Key?(f[d].key=b[g].bindKey[c],e.setText(d)):f[d].bindKey&&(f[d].hasOwnProperty("key")||(f[d].key=f[d].bindKey[c],e.setText(d)))}}},this.getShortcuts=function(a){var b="<ul>";for(var d in f)f[d].hasOwnProperty("key")&&(b+="<li>",b+=f[d].title+" ("+f[d].key+")",b+="</li>");if(b+="</ul>",a){b+="<h5>"+c.str("edit")+"</h5>";var e=a.commands.commands,g=a.commands.platform;b+="<ul>";for(var h in e)e[h].hasOwnProperty("bindKey")&&e[h].bindKey[g]>""&&(b+="<li>",b+=h+" ("+e[h].bindKey[g]+")",b+="</li>");b+="</ul>"}return"<ul></ul>"==b?"":b},a(b).on("click","a",function(b){if(a(this).data("vpl-active")){var c=a(this).attr("id");if("string"!=typeof c||!c.startsWith("vpl_ide_"))return;if(c=c.replace("vpl_ide_",""),e.notAdded(c))return;if(f[c]&&!f[c].active)return;var d=e.getAction(c);"import"!=c?setTimeout(d,10):d()}return b.stopImmediatePropagation(),!1}),a("body").on("keydown",function(a){var b=!1,c="";if(a.shiftKey&&(c+="shift-"),a.altKey&&(c+="alt-",b=!0),a.ctrlKey&&(c+="ctrl-",b=!0),a.metaKey&&(c+="meta-",b=!0),a.which>=112&&a.which<=123)c+="f"+(a.which-111),b=!0;else{var d=String.fromCharCode(a.which).toLowerCase();d<"a"||d>"z"?b=!1:c+=d}if(b)for(var e in f)if(f[e].hasOwnProperty("key")&&c==f[e].key.toLowerCase())return a.preventDefault(),a.stopImmediatePropagation(),f[e].action(),!1}),this.multiple=function(a,b){return a-a%b},function(){var b=0,d=0,f=!1,g=3600,h=24*g,i="vpl_buttonleft_orange vpl_buttonleft_red vpl_buttonleft_black",j=!1,k=null,l=5,m=1e3,n=0,o=function(a){l=5,m=1e3,a>g?(l=60,m=5e3):a>h&&(l=300,m=25e3)},p=function(){var a=e.multiple(c.getCurrentTime(),l);if(a!==d&&null!==k){d=a;var f=n-(d-b),g="";f<=0?g="vpl_buttonleft_black":f<=300?(j=!0,g="vpl_buttonleft_red"):f<=900?g="vpl_buttonleft_orange":o(f);var h='<span class="'+g+'">'+c.genIcon("timeleft");j&&(h+=" "+c.getTimeLeft(f)),h+="</span>",k.html(h),k.removeClass(i),k.addClass(g)}};e.toggleTimeLeft=function(){j=!j,d=0,p()},e.setTimeLeft=function(g){if(k=a("#vpl_ide_timeleft"),f!==!1&&(clearInterval(f),f=!1),g.hasOwnProperty("timeLeft")){n=g.timeLeft,o(n);var h=n%l;n=e.multiple(n,l),b=e.multiple(c.getCurrentTime(),l),d=b-l,setTimeout(function(){f=setInterval(p,m)},1e3*h),a("#vpl_ide_timeleft").show(),p()}else a("#vpl_ide_timeleft").hide()}}()};return window.VPLIDEButtons=d,d});